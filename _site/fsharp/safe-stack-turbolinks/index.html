<!doctype html>
<!--
  Minimal Mistakes Jekyll Theme 4.20.2 by Michael Rose
  Copyright 2013-2020 Michael Rose - mademistakes.com | @mmistakes
  Free for personal and commercial use under the MIT license
  https://github.com/mmistakes/minimal-mistakes/blob/master/LICENSE
-->
<html lang="en" class="no-js">
  <head>
    <meta charset="utf-8">

<!-- begin _includes/seo.html --><title>Using Turbolinks with the SAFE web stack - Viktor Andersson</title>
<meta name="description" content="“Do you really need a single-page application for that?”">


  <meta name="author" content="Viktor Andersson">
  
  <meta property="article:author" content="Viktor Andersson">
  


<meta property="og:type" content="article">
<meta property="og:locale" content="en_US">
<meta property="og:site_name" content="Viktor Andersson">
<meta property="og:title" content="Using Turbolinks with the SAFE web stack">
<meta property="og:url" content="https://viktorvan.github.io/fsharp/safe-stack-turbolinks/">


  <meta property="og:description" content="“Do you really need a single-page application for that?”">



  <meta property="og:image" content="https://viktorvan.github.io/assets/images/sf_twins.jpg">



  <meta name="twitter:site" content="@Emmet_Ray">
  <meta name="twitter:title" content="Using Turbolinks with the SAFE web stack">
  <meta name="twitter:description" content="“Do you really need a single-page application for that?”">
  <meta name="twitter:url" content="https://viktorvan.github.io/fsharp/safe-stack-turbolinks/">

  
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:image" content="https://viktorvan.github.io/assets/images/sf_twins.jpg">
  

  



  <meta property="article:published_time" content="2020-07-22T17:00:00+02:00">





  

  


<link rel="canonical" href="https://viktorvan.github.io/fsharp/safe-stack-turbolinks/">




<script type="application/ld+json">
  {
    "@context": "https://schema.org",
    
      "@type": "Person",
      "name": "Viktor Andersson",
      "url": "https://viktorvan.github.io/"
    
  }
</script>






<!-- end _includes/seo.html -->


<link href="/feed.xml" type="application/atom+xml" rel="alternate" title="Viktor Andersson Feed">

<!-- https://t.co/dKP3o1e -->
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script>
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
</script>

<!-- For all browsers -->
<link rel="stylesheet" href="/assets/css/main.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5/css/all.min.css">

<!--[if IE]>
  <style>
    /* old IE unsupported flexbox fixes */
    .greedy-nav .site-title {
      padding-right: 3em;
    }
    .greedy-nav button {
      position: absolute;
      top: 0;
      right: 0;
      height: 100%;
    }
  </style>
<![endif]-->



    <script async defer data-domain="viktorvan.github.io" src="https://plausible.io/js/plausible.js"></script>
<script>window.plausible = window.plausible || function() { (window.plausible.q = window.plausible.q || []).push(arguments) }</script> 
<script>
    document.addEventListener("click", function(event) {
        if (event.target.closest('a[href="https://github.com/viktorvan"]'))
        {
            plausible('GithubProfile')
        }
        if (event.target.closest('a[href="https://twitter.com/Emmet_Ray"]'))
        {
            plausible('TwitterProfile')
        }
        if (event.target.closest('a[href="https://www.linkedin.com/in/viktorand/"]'))
        {
            plausible('LinkedInProfile')
        }
    });
</script>
<link rel="stylesheet" href="style.css">
  </head>

  <body class="layout--single wide">
    <nav class="skip-links">
  <h2 class="screen-reader-text">Skip links</h2>
  <ul>
    <li><a href="#site-nav" class="screen-reader-shortcut">Skip to primary navigation</a></li>
    <li><a href="#main" class="screen-reader-shortcut">Skip to content</a></li>
    <li><a href="#footer" class="screen-reader-shortcut">Skip to footer</a></li>
  </ul>
</nav>

    <!--[if lt IE 9]>
<div class="notice--danger align-center" style="margin: 0;">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience.</div>
<![endif]-->

    

<div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="greedy-nav">
        
        <a class="site-title" href="/">
          Viktor Andersson
          
        </a>
        <ul class="visible-links"><li class="masthead__menu-item">
              <a href="/tags/">Tags</a>
            </li></ul>
        
        <button class="greedy-nav__toggle hidden" type="button">
          <span class="visually-hidden">Toggle menu</span>
          <div class="navicon"></div>
        </button>
        <ul class="hidden-links hidden"></ul>
      </nav>
    </div>
  </div>
</div>


    <div class="initial-content">
      
  







<div class="page__hero--overlay"
  style=" background-image: linear-gradient(rgba(0, 0, 0, 0.4), rgba(0, 0, 0, 0.4)), url('/assets/images/sf_twins.jpg');"
>
  
    <div class="wrapper">
      <h1 id="page-title" class="page__title" itemprop="headline">
        
          Using Turbolinks with the SAFE web stack

        
      </h1>
      
        <p class="page__lead">“Do you really need a single-page application for that?”

</p>
      
      

  <p class="page__meta">
    

    

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          14 minute read
        
      </span>
    
  </p>


      
      
    </div>
  
  
</div>





<div id="main" role="main">
  
  <div class="sidebar sticky">
  


<div itemscope itemtype="https://schema.org/Person">

  
    <div class="author__avatar">
      
        <img src="/assets/images/bio-photo-blue.jpeg" alt="Viktor Andersson" itemprop="image">
      
    </div>
  

  <div class="author__content">
    
      <h3 class="author__name" itemprop="name">Viktor Andersson</h3>
    
    
      <div class="author__bio" itemprop="description">
        <p>Software developer, beekeeper and F# enthusiast</p>

      </div>
    
  </div>

  <div class="author__urls-wrapper">
    <button class="btn btn--inverse">Follow</button>
    <ul class="author__urls social-icons">
      
        <li itemprop="homeLocation" itemscope itemtype="https://schema.org/Place">
          <i class="fas fa-fw fa-map-marker-alt" aria-hidden="true"></i> <span itemprop="name">Stockholm, Sweden</span>
        </li>
      

      
        
          
            <li><a href="mailto:v.andersson@me.com" rel="nofollow noopener noreferrer"><i class="fas fa-fw fa-envelope-square" aria-hidden="true"></i><span class="label">Email</span></a></li>
          
        
          
        
          
            <li><a href="https://twitter.com/Emmet_Ray" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-twitter-square" aria-hidden="true"></i><span class="label">Twitter</span></a></li>
          
        
          
        
          
            <li><a href="https://github.com/viktorvan" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-github" aria-hidden="true"></i><span class="label">GitHub</span></a></li>
          
        
          
        
          
            <li><a href="https://www.linkedin.com/in/viktorand/" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-linkedin" aria-hidden="true"></i><span class="label">LinkedIn</span></a></li>
          
        
      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      <!--
  <li>
    <a href="http://link-to-whatever-social-network.com/user/" itemprop="sameAs" rel="nofollow noopener noreferrer">
      <i class="fas fa-fw" aria-hidden="true"></i> Custom Social Profile Link
    </a>
  </li>
-->
    </ul>
  </div>
</div>

  
  </div>



  <article class="page" itemscope itemtype="https://schema.org/CreativeWork">
    <meta itemprop="headline" content="Using Turbolinks with the SAFE web stack">
    <meta itemprop="description" content="“Do you really need a single-page application for that?”">
    <meta itemprop="datePublished" content="2020-07-22T17:00:00+02:00">
    

    <div class="page__inner-wrap">
      

      <section class="page__content" itemprop="text">
        
          <aside class="sidebar__right ">
            <nav class="toc">
              <header><h4 class="nav__title"><i class="fas fa-file-alt"></i> On this page</h4></header>
              <ul class="toc__menu">
  <li><a href="#background---what-is-turbolinks">Background - What is Turbolinks?</a></li>
  <li><a href="#the-demo-application">The demo application</a></li>
  <li><a href="#our-goals">Our goals</a></li>
  <li><a href="#step-1-render-all-html-on-the-server">Step 1. Render all html on the server</a></li>
  <li><a href="#step-2-navigate-dates-using-turbolinks">Step 2. Navigate dates using Turbolinks</a>
    <ul>
      <li><a href="#step-2b-dealing-with-permanent-elements">Step 2b. Dealing with “permanent” elements</a></li>
      <li><a href="#step-2c-using-the-date-input-to-navigate-dates">Step 2c. Using the date input to navigate dates</a></li>
    </ul>
  </li>
  <li><a href="#step-3-edit-data">Step 3. Edit data</a>
    <ul>
      <li><a href="#step-3b-saving-scroll-position">Step 3b. Saving scroll position</a></li>
    </ul>
  </li>
  <li><a href="#step-4-deal-with-redirects">Step 4. Deal with redirects</a></li>
  <li><a href="#conclusions">Conclusions</a></li>
</ul>

            </nav>
          </aside>
        
        <p>“Do you really need a single-page application for that?”</p>

<h3 id="background---what-is-turbolinks">Background - What is Turbolinks?</h3>

<p>Turbolinks is a javascript library that gives your web application the look and feel of a single-page application, without really being one. The idea is that it intercepts any navigation and instead of reloading the page at that point, it fetches the page in the background and just switches the whole html &lt;body&gt; from response with the current body. A little simplified of course.</p>

<p>From the Turbolinks documentation:</p>

<blockquote>
  <p>Turbolinks® makes navigating your web application faster. Get the performance benefits of a single-page application without the added complexity of a client-side JavaScript framework. Use HTML to render your views on the server side and link to pages as usual. When you follow a link, Turbolinks automatically fetches the page, swaps in its &lt;body&gt;, and merges its &lt;head&gt;, all without incurring the cost of a full page load.</p>
</blockquote>

<p>Turbolinks can be a good compromise when only a little interactivity is needed on the frontend, and you don’t want to setup a full single page application. It gives the user the feel a single-page application, but most of the business logic can be kept server-side.</p>

<p>I was previously using Elmish for this application, and so far I prefer this “simpler” solution I ended up with when using Turbolinks. But I should say that this is a quite simple application. If there is a lot of stuff going on the client-side I wouldn’t hesitate to use Elmish. Or maybe a hybrid approach with Turbolinks for most of the application and the <a href="https://zaid-ajaj.github.io/Feliz/#/Hooks/UseElmish">Feliz.UseElmish</a> React hook for any complicated components.</p>

<p>Turbolinks is originally a Ruby on Rails feature, but it really is just a javascript library that you load on your client, so you can use it with any webstack that uses javascript on the frontend<sup id="fnref:1"><a href="#fn:1" class="footnote">1</a></sup>. In this example I am using the F# <a href="https://safe-stack.github.io/">SAFE webstack</a> with <a href="https://saturnframework.org/">Saturn</a>/<a href="https://github.com/giraffe-fsharp/Giraffe">Giraffe</a>, if you for some reason prefer to work with something else, maybe C# and ASP.NET Core MVC it is still possible to benefit from using Turbolinks, of course.</p>

<h3 id="the-demo-application">The demo application</h3>

<p>The demo application is a simplified version of an application I am using to keep track of how many eggs my chickens are laying. It is a very simple application where you can select a date and see what chickens that have laid an egg that day. You can also add/remove eggs; click on a chicken to add an egg, click on an egg to remove it. At the bottom we display some totals. Simple as that.</p>

<p><img src="/assets/images/safe-turbolinks-demo-application.gif" alt="demo application" /></p>

<p>The complete demo application is available on <a href="https://github.com/viktorvan/safe-stack-turbolinks-demo">github</a>.</p>

<h3 id="our-goals">Our goals</h3>

<p>So the goals we are reaching for with our Turbolinks enabled application is to:</p>

<ol>
  <li>Render all html on the server.</li>
  <li>Navigate different dates: use Turbolinks to out-of-the-box handle page navigation.</li>
  <li>Edit data (add/remove eggs): use add some client side interactivity with javascript (or fable, rather).</li>
  <li>Deal with redirects</li>
</ol>

<h3 id="step-1-render-all-html-on-the-server">Step 1. Render all html on the server</h3>

<p>I started out with an existing elmish application, so I was previously rendering the views with Fable, using <a href="https://zaid-ajaj.github.io/Feliz/">Feliz</a> and <a href="https://dzoukr.github.io/Feliz.Bulma/">Feliz.Bulma</a>. The client was then using <a href="https://zaid-ajaj.github.io/Fable.Remoting/">Fable.Remoting</a> to load and save data from the backend. 
The interface for the Fable.Remoting api was initially:</p>

<div class="language-fsharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">type</span> <span class="nc">IChickenApi</span> <span class="p">=</span>
        <span class="p">{</span> <span class="nc">GetAllChickens</span><span class="p">:</span> <span class="nc">NotFutureDate</span> <span class="p">-&gt;</span> <span class="nc">Async</span><span class="p">&lt;</span><span class="nc">Chicken</span> <span class="kt">list</span><span class="p">&gt;</span>
          <span class="nc">GetEggCount</span><span class="p">:</span> <span class="nc">NotFutureDate</span> <span class="p">*</span> <span class="nc">ChickenId</span> <span class="kt">list</span> <span class="p">-&gt;</span> <span class="nc">Async</span><span class="p">&lt;</span><span class="nc">Map</span><span class="p">&lt;</span><span class="nc">ChickenId</span><span class="p">,</span> <span class="nc">EggCount</span><span class="o">&gt;&gt;</span> 
          <span class="nc">AddEgg</span><span class="p">:</span> <span class="nc">ChickenId</span> <span class="p">*</span> <span class="nc">NotFutureDate</span> <span class="p">-&gt;</span> <span class="nc">Async</span><span class="p">&lt;</span><span class="kt">unit</span><span class="p">&gt;</span>
          <span class="nc">RemoveEgg</span><span class="p">:</span> <span class="nc">ChickenId</span> <span class="p">*</span> <span class="nc">NotFutureDate</span> <span class="p">-&gt;</span> <span class="nc">Async</span><span class="p">&lt;</span><span class="kt">unit</span><span class="p">&gt;</span> <span class="p">}</span>
</code></pre></div></div>

<p>For completeness, here are the types it’s using</p>
<div class="language-fsharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">type</span> <span class="nc">ChickenId</span> <span class="p">=</span> <span class="nc">ChickenId</span> <span class="k">of</span> <span class="nc">Guid</span>
<span class="k">type</span> <span class="nc">EggCount</span> <span class="p">=</span> <span class="nc">EggCount</span> <span class="k">of</span> <span class="kt">int</span>
<span class="k">type</span> <span class="nc">Chicken</span> <span class="p">=</span>
    <span class="p">{</span> <span class="nc">Id</span><span class="p">:</span> <span class="nc">ChickenId</span>
      <span class="nc">Name</span><span class="p">:</span> <span class="kt">string</span>
      <span class="nc">ImageUrl</span><span class="p">:</span> <span class="nc">ImageUrl</span> <span class="n">option</span>
      <span class="nc">Breed</span><span class="p">:</span> <span class="kt">string</span> 
      <span class="nc">TotalCount</span><span class="p">:</span> <span class="nc">EggCount</span> <span class="p">}</span>
<span class="k">type</span> <span class="nc">NotFutureDate</span> <span class="p">=</span>
    <span class="p">{</span> <span class="nc">Year</span><span class="p">:</span> <span class="kt">int</span>
      <span class="nc">Month</span><span class="p">:</span> <span class="kt">int</span>
      <span class="nc">Day</span><span class="p">:</span> <span class="kt">int</span> <span class="p">}</span>
</code></pre></div></div>

<p>In our Turbolinks application the html will be rendered on the server instead, so i need to move my views to the backend. The backend I am using (Saturn/Giraffe) has a view engine that i could use, but there is even a view engine available for <a href="https://github.com/dbrattli/feliz.viewengine">Feliz and Feliz.Bulma</a>. So that made my work really easy, I could just copy my views from the client to the server, and remove anything related to event listeners, <code class="highlighter-rouge">onchange</code>, <code class="highlighter-rouge">onselect</code>, etc.</p>

<p>This means I will no longer be needing the <code class="highlighter-rouge">Get...</code> functions in the <code class="highlighter-rouge">IChickenApi</code>. That data will now be returned as a single html view from the backend. The browser client no longer needs to be dealing with updating react views with the chicken and eggcount data returned from the api. It just needs to display the html. Simple. We are left with some edit functions that we will be using in a later step:</p>

<div class="language-fsharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">type</span> <span class="nc">IChickenApi</span> <span class="p">=</span>
        <span class="p">{</span> <span class="nc">AddEgg</span><span class="p">:</span> <span class="nc">ChickenId</span> <span class="p">*</span> <span class="nc">NotFutureDate</span> <span class="p">-&gt;</span> <span class="nc">Async</span><span class="p">&lt;</span><span class="kt">unit</span><span class="p">&gt;</span>
          <span class="nc">RemoveEgg</span><span class="p">:</span> <span class="nc">ChickenId</span> <span class="p">*</span> <span class="nc">NotFutureDate</span> <span class="p">-&gt;</span> <span class="nc">Async</span><span class="p">&lt;</span><span class="kt">unit</span><span class="p">&gt;</span> <span class="p">}</span>
</code></pre></div></div>

<p>And I have made the following addition in my <a href="https://github.com/viktorvan/safe-stack-turbolinks-demo/-blob/master/src/Server/Server.fs">server setup</a>:</p>

<div class="language-fsharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Server.fs</span>

<span class="k">let</span> <span class="n">defaultRoute</span><span class="bp">()</span> <span class="p">=</span> <span class="n">sprintf</span> <span class="s2">"/chickens?date=%s"</span> <span class="p">(</span><span class="nn">NotFutureDate</span><span class="p">.</span><span class="n">today</span><span class="bp">()</span><span class="p">.</span><span class="nc">ToString</span><span class="bp">()</span><span class="p">)</span>
<span class="k">let</span> <span class="n">browser</span> <span class="p">=</span> <span class="n">router</span> <span class="p">{</span>
    <span class="n">get</span> <span class="s2">"/"</span> <span class="p">(</span><span class="n">redirectTo</span> <span class="bp">false</span> <span class="p">(</span><span class="n">defaultRoute</span><span class="bp">()</span><span class="o">))</span>
    <span class="n">get</span> <span class="s2">"/chickens"</span> <span class="n">chickensView</span>
<span class="p">}</span>
</code></pre></div></div>

<p>where <a href="https://github.com/viktorvan/safe-stack-turbolinks-demo/blob/master/src/Server/Views/Chickens.fs">chickensView</a> renders the html.</p>

<p>We can now navigate the application as a normal server application and use the arrow buttons to change date. We cannot use the datepicker yet though, or add/remove eggs, since that requires some javascript on the client side. We will fix that in later steps.</p>

<h3 id="step-2-navigate-dates-using-turbolinks">Step 2. Navigate dates using Turbolinks</h3>

<p>To enable Turbolinks you could just add it in a script tag in your html head:</p>
<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;script </span><span class="na">src=</span><span class="s">"https://cdnjs.cloudflare.com/ajax/libs/turbolinks/5.1.1/turbolinks.js"</span><span class="nt">&gt;&lt;/script&gt;</span>
</code></pre></div></div>

<p>but since I will be adding some javascript of my own and will be creating my own javascript bundle, I will <a href="https://github.com/turbolinks/turbolinks#installation-using-npm">install Turbolinks with npm</a> and require it instead:</p>

<div class="language-ini highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">npm</span> <span class="err">install</span> <span class="err">--save</span> <span class="err">turbolinks</span>
</code></pre></div></div>

<div class="language-fsharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Turbolinks.fs</span>
<span class="k">module</span> <span class="nn">Client</span><span class="p">.</span><span class="nc">Turbolinks</span>

<span class="k">open</span> <span class="nn">Fable</span><span class="p">.</span><span class="nn">Core</span><span class="p">.</span><span class="nc">JsInterop</span>

<span class="k">type</span> <span class="k">private</span> <span class="nc">ITurbolinksLib</span> <span class="p">=</span>
    <span class="k">abstract</span> <span class="n">start</span> <span class="p">:</span> <span class="kt">unit</span> <span class="p">-&gt;</span> <span class="kt">unit</span>
    <span class="k">abstract</span> <span class="n">clearCache</span> <span class="p">:</span> <span class="kt">unit</span> <span class="p">-&gt;</span> <span class="kt">unit</span>
    <span class="k">abstract</span> <span class="n">visit</span> <span class="p">:</span> <span class="kt">string</span> <span class="p">-&gt;</span> <span class="kt">unit</span>

<span class="k">let</span> <span class="k">private</span> <span class="n">turbolinks</span> <span class="p">:</span> <span class="nc">ITurbolinksLib</span> <span class="p">=</span> <span class="n">importDefault</span> <span class="s2">"turbolinks"</span>

<span class="k">let</span> <span class="n">start</span><span class="bp">()</span> <span class="p">=</span> <span class="n">turbolinks</span><span class="p">.</span><span class="n">start</span><span class="bp">()</span>
<span class="k">let</span> <span class="n">visit</span> <span class="n">url</span> <span class="p">=</span> <span class="n">turbolinks</span><span class="p">.</span><span class="n">visit</span> <span class="n">url</span>
<span class="k">let</span> <span class="n">reset</span><span class="bp">()</span> <span class="p">=</span>
    <span class="n">turbolinks</span><span class="p">.</span><span class="n">clearCache</span><span class="bp">()</span>
    <span class="n">turbolinks</span><span class="p">.</span><span class="n">visit</span> <span class="s2">""</span>
</code></pre></div></div>

<p>then, in my client <a href="https://github.com/viktorvan/safe-stack-turbolinks-demo/blob/master/src/Client/App.fs">entry-point</a> I add</p>
<div class="language-fsharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// App.fs</span>
<span class="nn">Turbolinks</span><span class="p">.</span><span class="n">start</span><span class="bp">()</span>
</code></pre></div></div>

<p>If I run the app now, and try to navigate using the navigation arrows, there are no longer any page reloads in the browser. Scripts and css are only loaded on the first page load. Turbolinks is doing it’s magic and intercepting navigation events and loading the data in the background. It also caches any visited pages, and will display the cached version while loading new data from the server.</p>

<h4 id="step-2b-dealing-with-permanent-elements">Step 2b. Dealing with “permanent” elements</h4>

<p>For this example i have added a navbar to the application, it displays the version of the application. On a narrow screen the link will be replaced with a burger menu button which the user can choose to expand. Except, there is no longer any javascript that expands that menu since I removed everything from the Elmish application. Let’s add that functionality back again<sup id="fnref:2"><a href="#fn:2" class="footnote">2</a></sup>:</p>

<p>First we need to setup webpack to bundle our client scripts. I am using the webpack.config.js generated by the <a href="https://safe-stack.github.io/docs/template-overview/">safe-template</a> as starting point. Since we no longer will be running the client as a single page application I remove all the sections related to the webpack-dev-server. Also, we won’t be serving an index.html directly, that is going to be rendered by our server, so I remove the index.html file and the HtmlWebpackPlugin. This is my resulting <a href="https://github.com/viktorvan/safe-stack-turbolinks-demo/blob/master/webpack.config.js">webpack.config.js</a><sup id="fnref:3"><a href="#fn:3" class="footnote">3</a></sup>.</p>

<p>We need to add an event listener for the navbar burger button that toggles <code class="highlighter-rouge">is-active</code> class on the corresponding navbar elements.</p>

<p>First some functions to toggle the classes:</p>

<div class="language-fsharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">open</span> <span class="nc">Browser</span>

<span class="k">let</span> <span class="n">toggleClass</span> <span class="n">className</span> <span class="p">(</span><span class="n">e</span><span class="p">:</span> <span class="nc">Element</span><span class="p">)</span> <span class="p">=</span>
    <span class="k">let</span> <span class="n">newClasses</span> <span class="p">=</span>
        <span class="k">if</span> <span class="n">e</span><span class="p">.</span><span class="n">className</span><span class="p">.</span><span class="nc">Contains</span><span class="p">(</span><span class="n">className</span><span class="p">)</span> <span class="k">then</span>
            <span class="n">e</span><span class="p">.</span><span class="n">className</span><span class="p">.</span><span class="nc">Replace</span><span class="p">(</span><span class="n">className</span><span class="p">,</span> <span class="s2">""</span><span class="p">)</span>
        <span class="k">else</span>
            <span class="n">e</span><span class="p">.</span><span class="n">className</span> <span class="o">+</span> <span class="s2">" "</span> <span class="o">+</span> <span class="n">className</span>
    <span class="n">e</span><span class="p">.</span><span class="n">className</span> <span class="p">&lt;-</span> <span class="n">newClasses</span>

<span class="k">let</span> <span class="n">toggleNavbarMenu</span> <span class="bp">()</span> <span class="p">=</span>
    <span class="n">document</span><span class="p">.</span><span class="n">getElementById</span><span class="p">(</span><span class="s2">"chickencheck-navbar-burger"</span><span class="p">)</span>
    <span class="p">|&gt;</span> <span class="nn">Option</span><span class="p">.</span><span class="n">ofObj</span>
    <span class="p">|&gt;</span> <span class="nn">Option</span><span class="p">.</span><span class="n">iter</span> <span class="p">(</span><span class="n">toggleClass</span> <span class="s2">"is-active"</span><span class="p">)</span>
    <span class="n">document</span><span class="p">.</span><span class="n">getElementById</span><span class="p">(</span><span class="s2">"chickencheck-navbar-menu"</span><span class="p">)</span>
    <span class="p">|&gt;</span> <span class="nn">Option</span><span class="p">.</span><span class="n">ofObj</span>
    <span class="p">|&gt;</span> <span class="nn">Option</span><span class="p">.</span><span class="n">iter</span> <span class="p">(</span><span class="n">toggleClass</span> <span class="s2">"is-active"</span><span class="p">)</span>
</code></pre></div></div>

<p>then, using event delegation we add the following event listener:</p>

<div class="language-fsharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// App.fs</span>

<span class="n">document</span><span class="p">.</span><span class="n">onclick</span> <span class="p">&lt;-</span>
    <span class="k">fun</span> <span class="n">ev</span> <span class="p">-&gt;</span>
        <span class="k">let</span> <span class="n">target</span> <span class="p">=</span> <span class="n">ev</span><span class="p">.</span><span class="n">target</span> <span class="o">:?&gt;</span> <span class="nc">Element</span>
        <span class="k">if</span> <span class="n">target</span><span class="p">.</span><span class="n">closest</span><span class="p">(</span><span class="s2">".navbar-burger"</span><span class="o">).</span><span class="nc">IsSome</span> <span class="k">then</span>
            <span class="nn">Navbar</span><span class="p">.</span><span class="n">toggleNavbarMenu</span><span class="bp">()</span>
</code></pre></div></div>

<p>But we will be adding some more onclick events later on, let’s refactor this a bit. The <a href="https://fsharpforfunandprofit.com/posts/convenience-active-patterns/">Active Pattern</a> feature of F# will come in handy here, let’s define a pattern for our navbar button target:</p>

<div class="language-fsharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="k">let</span> <span class="o">(|</span><span class="nc">NavbarBurger</span><span class="o">|_|)</span> <span class="p">(</span><span class="n">target</span><span class="p">:</span> <span class="nc">Element</span><span class="p">)</span> <span class="p">=</span>
        <span class="k">if</span> <span class="n">target</span><span class="p">.</span><span class="n">closest</span><span class="p">(</span><span class="s2">".navbar-burger"</span><span class="o">).</span><span class="nc">IsSome</span> <span class="k">then</span> 
            <span class="nc">Some</span> <span class="nc">NavbarBurger</span> 
        <span class="k">else</span> 
            <span class="nc">None</span>
</code></pre></div></div>

<p>and then use it when we add the event listener:</p>

<div class="language-fsharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// App.fs</span>
<span class="n">document</span><span class="p">.</span><span class="n">onclick</span> <span class="p">&lt;-</span>
    <span class="k">fun</span> <span class="n">ev</span> <span class="p">-&gt;</span>
        <span class="k">match</span> <span class="n">ev</span><span class="p">.</span><span class="n">target</span> <span class="o">:?&gt;</span> <span class="nc">Element</span> <span class="k">with</span>
        <span class="p">|</span> <span class="nc">NavbarBurger</span> <span class="p">-&gt;</span> <span class="nn">Navbar</span><span class="p">.</span><span class="n">toggleNavbarMenu</span><span class="bp">()</span>
        <span class="p">|</span> <span class="p">_</span> <span class="p">-&gt;</span> <span class="bp">()</span>
</code></pre></div></div>

<p>if we try it out now, it <em>almost</em> works as expected:</p>

<p><img src="/assets/images/safe-turbolinks-toggle-navbar-menu1.gif" alt="toggling navbar menu" /></p>

<p>When navigating to another date, we expect that menu stays expanded, but it’s doesn’t. When Turbolinks replaces the html body with the new one it fetched from the server it will overwrite any changes we have done with javascript. But there is a solution for this, we need to mark our navbar with the <a href="https://github.com/turbolinks/turbolinks#persisting-elements-across-page-loads"><code class="highlighter-rouge">data-turbolinks-permanent</code></a> attribute<sup id="fnref:4"><a href="#fn:4" class="footnote">4</a></sup>:</p>

<div class="language-fsharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="nn">Bulma</span><span class="p">.</span><span class="n">navbar</span> <span class="p">[</span>
        <span class="n">prop</span><span class="p">.</span><span class="n">id</span> <span class="s2">"chickencheck-navbar"</span>
        <span class="n">prop</span><span class="p">.</span><span class="n">custom</span> <span class="p">(</span><span class="s2">"data-turbolinks-permanent"</span><span class="p">,</span> <span class="s2">""</span><span class="p">)</span>
        <span class="c1">// ...</span>
</code></pre></div></div>

<p>With this attribute in place Turbolinks will save that element and transfer it to the new page, preserving the data and event listeners. Now the navbar menu will stay expanded even when navigating:</p>

<p><img src="/assets/images/safe-turbolinks-toggle-navbar-menu2.gif" alt="toggling navbar menu" /></p>

<h4 id="step-2c-using-the-date-input-to-navigate-dates">Step 2c. Using the date input to navigate dates</h4>

<p>Now let’s hook up the datepicker to actually do some navigation. For cross-platform styling of the date input I am using <a href="https://creativebulma.net/product/calendar">Bulma.Calendar</a>. The Bulma-calendar datepicker needs to be attached (or refreshed) every time we load the page, so we need to add some initialization code when our page is loaded. But we cannot do this in <code class="highlighter-rouge">window.onload</code> since with Turbolinks active this event is only triggered once on first page load. Instead we need to do our initialization in the Turbolinks custom event <code class="highlighter-rouge">turbolinks:load</code>:</p>

<div class="language-fsharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// App.fs</span>

<span class="n">document</span><span class="p">.</span><span class="n">addEventListener</span><span class="p">(</span><span class="s2">"turbolinks:load"</span><span class="p">,</span> <span class="k">fun</span> <span class="p">_</span> <span class="p">-&gt;</span>
    <span class="nn">Datepicker</span><span class="p">.</span><span class="n">init</span> <span class="bp">()</span><span class="p">)</span>

<span class="c1">// Datepicker.fs</span>
<span class="k">let</span> <span class="n">init</span><span class="bp">()</span> <span class="p">=</span>

    <span class="k">let</span> <span class="n">datepicker</span> <span class="p">=</span> <span class="n">getDatePickerElement</span><span class="bp">()</span>
    <span class="n">datepicker</span><span class="p">.</span><span class="nc">OnSelect</span><span class="p">(</span><span class="k">fun</span> <span class="p">_</span> <span class="p">-&gt;</span>
        <span class="k">let</span> <span class="n">date</span> <span class="p">=</span>
            <span class="n">datepicker</span><span class="p">.</span><span class="n">date</span><span class="p">.</span><span class="n">start</span>
            <span class="p">|&gt;</span> <span class="nn">Option</span><span class="p">.</span><span class="n">ofNullable</span>
            <span class="p">|&gt;</span> <span class="nn">Option</span><span class="p">.</span><span class="n">map</span> <span class="nn">NotFutureDate</span><span class="p">.</span><span class="n">create</span>
            <span class="p">|&gt;</span> <span class="nn">Option</span><span class="p">.</span><span class="n">defaultValue</span> <span class="p">(</span><span class="nn">NotFutureDate</span><span class="p">.</span><span class="n">today</span><span class="bp">()</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">date</span> <span class="p">&lt;&gt;</span> <span class="n">currentDate</span> <span class="k">then</span>
            <span class="k">let</span> <span class="n">dateQueryStr</span> <span class="p">=</span> <span class="n">sprintf</span> <span class="s2">"?date=%s"</span> <span class="p">(</span><span class="n">date</span><span class="p">.</span><span class="nc">ToString</span><span class="bp">()</span><span class="p">)</span>
            <span class="nn">Turbolinks</span><span class="p">.</span><span class="n">visit</span><span class="p">(</span><span class="n">window</span><span class="p">.</span><span class="n">location</span><span class="p">.</span><span class="n">pathname</span> <span class="o">+</span> <span class="n">dateQueryStr</span><span class="o">))</span>
    <span class="p">)</span>
</code></pre></div></div>

<p>I have omitted and simplified a little bit here<sup id="fnref:5"><a href="#fn:5" class="footnote">5</a></sup>, but the gist is that we attach an event listener and if the date has changed we use Turbolinks to programmatically navigate to the page for the new date using <code class="highlighter-rouge">Turbolinks.visit(url)</code>. <code class="highlighter-rouge">visit</code> works just like if we navigated by clicking a hyperlink, if a preview is available it is displayed first while the new page is loaded in the background.</p>

<p>Now we can use the datepicker to navigate:</p>

<p><img src="/assets/images/safe-turbolinks-datepicker.gif" alt="navigating with datepicker" /></p>

<h3 id="step-3-edit-data">Step 3. Edit data</h3>

<p>Now let’s implement the last missing feature, adding and removing eggs for chickens.</p>

<p>With Turbolinks, when we editing data we don’t want to submit a form like in a normal web application. The suggested pattern from the <a href="https://github.com/turbolinks/turbolinks#redirecting-after-a-form-submission">Turbolinks documentation</a> is to submit the form data with XHR and then return javascript from the server that performs a <code class="highlighter-rouge">Turbolinks.visit(url)</code> and optionally <code class="highlighter-rouge">Turbolinks.clearCache()</code> if the cache needs to be cleared.</p>

<p>I.e. we need to send a request to the server, use visit to redirect to the page we want to end up at, and also clear the Turbolinks cache. I think Fable.Remoting is really convenient for client-server communication with Fable, so I will use that. Also I already had implemented a Fable.Remoting api in my Elmish version of this application.</p>

<p>The type signatures for the addEgg/removeEgg functions looks like this:</p>

<div class="language-fsharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">type</span> <span class="nc">IChickenApi</span> <span class="p">=</span>
        <span class="p">{</span> <span class="nc">AddEgg</span><span class="p">:</span> <span class="nc">ChickenId</span> <span class="p">*</span> <span class="nc">NotFutureDate</span> <span class="p">-&gt;</span> <span class="nc">Async</span><span class="p">&lt;</span><span class="kt">unit</span><span class="p">&gt;</span>
          <span class="nc">RemoveEgg</span><span class="p">:</span> <span class="nc">ChickenId</span> <span class="p">*</span> <span class="nc">NotFutureDate</span> <span class="p">-&gt;</span> <span class="nc">Async</span><span class="p">&lt;</span><span class="kt">unit</span><span class="p">&gt;</span> <span class="p">}</span>
</code></pre></div></div>

<p>When we are adding/removing eggs we need to know the id of the chicken we are performing the operation on. When rendering the html in the server this id is set as a data attribute on the chicken card and egg icon respectively. For convenience I have added a type extension to <code class="highlighter-rouge">Element</code> for easy access. In the same way <code class="highlighter-rouge">currentDate</code> is read from another data attribute:</p>

<div class="language-fsharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">module</span> <span class="nc">DataAttributes</span> <span class="p">=</span>
    <span class="k">let</span> <span class="n">parseChickenId</span> <span class="p">(</span><span class="n">element</span><span class="p">:</span> <span class="nc">Element</span><span class="p">)</span> <span class="p">=</span>
        <span class="n">element</span><span class="p">?</span><span class="n">dataset</span><span class="p">?</span><span class="n">chickenId</span>
        <span class="p">|&gt;</span> <span class="nn">ChickenId</span><span class="p">.</span><span class="n">parse</span>

    <span class="k">let</span> <span class="n">parseCurrentDate</span><span class="bp">()</span> <span class="p">=</span>
        <span class="n">document</span><span class="p">.</span><span class="n">querySelector</span><span class="p">(</span><span class="n">sprintf</span> <span class="s2">"[%s]"</span> <span class="nn">DataAttributes</span><span class="p">.</span><span class="nc">CurrentDate</span><span class="o">)?</span><span class="n">dataset</span><span class="p">?</span><span class="n">currentDate</span>
        <span class="p">|&gt;</span> <span class="nn">NotFutureDate</span><span class="p">.</span><span class="n">parse</span>

<span class="k">type</span> <span class="nc">Element</span> <span class="k">with</span>
    <span class="k">member</span> <span class="n">this</span><span class="p">.</span><span class="nc">ChickenId</span> <span class="p">=</span> <span class="nn">DataAttributes</span><span class="p">.</span><span class="n">parseChickenId</span><span class="p">(</span><span class="n">this</span><span class="p">)</span>
</code></pre></div></div>

<p>Add new active patterns, that also returns the parsed ChickenId:</p>

<div class="language-fsharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">let</span> <span class="k">private</span> <span class="n">tryGetEggIconElement</span> <span class="p">(</span><span class="n">target</span><span class="p">:</span> <span class="nc">Element</span><span class="p">)</span> <span class="p">=</span>
    <span class="n">target</span><span class="p">.</span><span class="n">closest</span><span class="p">(</span><span class="s2">".egg-icon"</span><span class="p">)</span>

<span class="k">let</span> <span class="o">(|</span><span class="nc">EggIcon</span><span class="o">|_|)</span> <span class="p">(</span><span class="n">target</span><span class="p">:</span> <span class="nc">Element</span><span class="p">)</span> <span class="p">=</span>
    <span class="n">target</span>
    <span class="p">|&gt;</span> <span class="n">tryGetEggIconElement</span>
    <span class="p">|&gt;</span> <span class="nn">Option</span><span class="p">.</span><span class="n">map</span> <span class="p">(</span><span class="k">fun</span> <span class="n">e</span> <span class="p">-&gt;</span> <span class="nc">EggIcon</span> <span class="n">e</span><span class="p">.</span><span class="nc">ChickenId</span><span class="p">)</span>

<span class="k">let</span> <span class="k">private</span> <span class="n">tryGetChickenCardElement</span> <span class="p">(</span><span class="n">target</span><span class="p">:</span> <span class="nc">Element</span><span class="p">)</span> <span class="p">=</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">tryGetEggIconElement</span> <span class="n">target</span> <span class="p">|&gt;</span> <span class="nn">Option</span><span class="p">.</span><span class="n">isSome</span><span class="p">)</span> <span class="k">then</span> <span class="nc">None</span>
    <span class="k">else</span>
        <span class="n">target</span><span class="p">.</span><span class="n">closest</span><span class="p">(</span><span class="s2">".chicken-card"</span><span class="p">)</span>

<span class="k">let</span> <span class="o">(|</span><span class="nc">ChickenCard</span><span class="o">|_|)</span> <span class="p">(</span><span class="n">target</span><span class="p">:</span> <span class="nc">Element</span><span class="p">)</span> <span class="p">=</span>
    <span class="n">target</span>
    <span class="p">|&gt;</span> <span class="n">tryGetChickenCardElement</span>
    <span class="p">|&gt;</span> <span class="nn">Option</span><span class="p">.</span><span class="n">map</span> <span class="p">(</span><span class="k">fun</span> <span class="n">e</span> <span class="p">-&gt;</span> <span class="nc">ChickenCard</span> <span class="n">e</span><span class="p">.</span><span class="nc">ChickenId</span><span class="p">)</span>
</code></pre></div></div>

<p>Hook them up in App.fs:</p>

<div class="language-fsharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// App.fs</span>
<span class="k">let</span> <span class="n">api</span> <span class="p">:</span> <span class="nc">IChickensApi</span> <span class="p">=</span>
    <span class="nn">Remoting</span><span class="p">.</span><span class="n">createApi</span><span class="bp">()</span>
    <span class="p">|&gt;</span> <span class="nn">Remoting</span><span class="p">.</span><span class="n">withRouteBuilder</span> <span class="nn">Route</span><span class="p">.</span><span class="n">builder</span>
    <span class="p">|&gt;</span> <span class="nn">Remoting</span><span class="p">.</span><span class="n">buildProxy</span><span class="p">&lt;</span><span class="nc">IChickensApi</span><span class="p">&gt;</span>

<span class="k">let</span> <span class="n">currentDate</span><span class="bp">()</span> <span class="p">=</span> <span class="nn">DataAttributes</span><span class="p">.</span><span class="n">parseCurrentDate</span><span class="bp">()</span>

<span class="n">document</span><span class="p">.</span><span class="n">onclick</span> <span class="p">&lt;-</span>
    <span class="k">fun</span> <span class="n">ev</span> <span class="p">-&gt;</span>
        <span class="k">match</span> <span class="n">ev</span><span class="p">.</span><span class="n">target</span> <span class="o">:?&gt;</span> <span class="n">element</span> <span class="k">with</span>
        <span class="p">|</span> <span class="nc">NavbarBurger</span> <span class="p">-&gt;</span> <span class="nn">Navbar</span><span class="p">.</span><span class="nc">ToggleNavbarMenu</span><span class="bp">()</span>
        <span class="p">|</span> <span class="nc">ChickenCard</span> <span class="n">chickenId</span> <span class="p">-&gt;</span> <span class="nn">Chickens</span><span class="p">.</span><span class="n">addEgg</span> <span class="n">api</span> <span class="n">chickenId</span> <span class="p">(</span><span class="n">currentDate</span><span class="bp">()</span><span class="p">)</span>
        <span class="p">|</span> <span class="nc">EggIcon</span> <span class="n">chickenId</span> <span class="p">-&gt;</span> <span class="nn">Chickens</span><span class="p">.</span><span class="n">removeEgg</span> <span class="n">api</span> <span class="n">chickenId</span> <span class="p">(</span><span class="n">currentDate</span><span class="bp">()</span><span class="p">)</span>
        <span class="p">|</span> <span class="p">_</span> <span class="p">-&gt;</span> <span class="bp">()</span>
</code></pre></div></div>

<p>And the implementation of addEgg/removeEgg:</p>

<div class="language-fsharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">let</span> <span class="n">addEgg</span> <span class="p">(</span><span class="n">api</span><span class="p">:</span> <span class="nc">IChickensApi</span><span class="p">)</span> <span class="p">(</span><span class="n">scrollPosition</span><span class="p">:</span> <span class="nc">ScrollPositionService</span><span class="p">)</span> <span class="p">=</span>
    <span class="k">fun</span> <span class="n">chickenId</span> <span class="n">date</span> <span class="p">-&gt;</span>
        <span class="n">async</span> <span class="p">{</span>
            <span class="k">try</span>
                <span class="n">window</span><span class="p">.</span><span class="k">event</span><span class="p">.</span><span class="n">stopPropagation</span><span class="bp">()</span>
                <span class="n">showEggLoader</span> <span class="n">chickenId</span>
                <span class="k">do</span><span class="o">!</span> <span class="n">api</span><span class="p">.</span><span class="nc">AddEgg</span><span class="p">(</span><span class="n">chickenId</span><span class="p">,</span> <span class="n">date</span><span class="p">)</span>
                <span class="nn">Turbolinks</span><span class="p">.</span><span class="n">reset</span><span class="bp">()</span>
            <span class="k">with</span> <span class="n">exn</span> <span class="p">-&gt;</span>
                <span class="n">eprintf</span> <span class="s2">"addEgg failed: %s"</span> <span class="n">exn</span><span class="p">.</span><span class="nc">Message</span>
        <span class="p">}</span>
        <span class="p">|&gt;</span> <span class="nn">Async</span><span class="p">.</span><span class="nc">StartImmediate</span>

<span class="k">let</span> <span class="n">removeEgg</span> <span class="p">(</span><span class="n">api</span><span class="p">:</span> <span class="nc">IChickensApi</span><span class="p">)</span> <span class="p">(</span><span class="n">scrollPosition</span><span class="p">:</span> <span class="nc">ScrollPositionService</span><span class="p">)</span> <span class="p">=</span>
    <span class="k">fun</span> <span class="n">chickenId</span> <span class="n">date</span> <span class="p">-&gt;</span>
        <span class="n">async</span> <span class="p">{</span>
            <span class="k">try</span>
                <span class="n">window</span><span class="p">.</span><span class="k">event</span><span class="p">.</span><span class="n">stopPropagation</span><span class="bp">()</span>
                <span class="n">hideEggIcon</span> <span class="n">chickenId</span>
                <span class="n">showEggLoader</span> <span class="n">chickenId</span>
                <span class="k">do</span><span class="o">!</span> <span class="n">api</span><span class="p">.</span><span class="nc">RemoveEgg</span><span class="p">(</span><span class="n">chickenId</span><span class="p">,</span> <span class="n">date</span><span class="p">)</span>
                <span class="nn">Turbolinks</span><span class="p">.</span><span class="n">reset</span><span class="bp">()</span>
            <span class="k">with</span> <span class="n">exn</span> <span class="p">-&gt;</span>
                <span class="n">eprintf</span> <span class="s2">"removeEgg failed: %s"</span> <span class="n">exn</span><span class="p">.</span><span class="nc">Message</span>
        <span class="p">}</span>
        <span class="p">|&gt;</span> <span class="nn">Async</span><span class="p">.</span><span class="nc">StartImmediate</span>
</code></pre></div></div>

<p><code class="highlighter-rouge">hideEggIcon</code> / <code class="highlighter-rouge">showEggLoader</code> are helper functions to show a loading spinner while waiting for the response from the server:</p>

<div class="language-fsharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">let</span> <span class="k">private</span> <span class="n">hideEggIcon</span> <span class="p">(</span><span class="n">id</span><span class="p">:</span> <span class="nc">ChickenId</span><span class="p">)</span> <span class="p">=</span>
    <span class="k">let</span> <span class="n">selector</span> <span class="p">=</span> <span class="n">sprintf</span> <span class="s2">".egg-icon[%s]"</span> <span class="p">(</span><span class="nn">DataAttributes</span><span class="p">.</span><span class="n">chickenIdStr</span> <span class="n">id</span><span class="p">)</span>
    <span class="n">document</span><span class="p">.</span><span class="n">querySelector</span> <span class="n">selector</span>
    <span class="p">|&gt;</span> <span class="nn">Option</span><span class="p">.</span><span class="n">ofObj</span>
    <span class="p">|&gt;</span> <span class="nn">Option</span><span class="p">.</span><span class="n">iter</span> <span class="p">(</span><span class="nn">HtmlHelper</span><span class="p">.</span><span class="n">toggleClass</span> <span class="s2">"is-hidden"</span><span class="p">)</span>

<span class="k">let</span> <span class="k">private</span> <span class="n">showEggLoader</span> <span class="p">(</span><span class="n">id</span><span class="p">:</span> <span class="nc">ChickenId</span><span class="p">)</span> <span class="p">=</span>
    <span class="k">let</span> <span class="n">selector</span> <span class="p">=</span> <span class="n">sprintf</span> <span class="s2">".egg-icon-loader[%s]"</span> <span class="p">(</span><span class="nn">DataAttributes</span><span class="p">.</span><span class="n">chickenIdStr</span> <span class="n">id</span><span class="p">)</span>
    <span class="n">document</span><span class="p">.</span><span class="n">querySelector</span> <span class="n">selector</span>
    <span class="p">|&gt;</span> <span class="nn">Option</span><span class="p">.</span><span class="n">ofObj</span>
    <span class="p">|&gt;</span> <span class="nn">Option</span><span class="p">.</span><span class="n">iter</span> <span class="p">(</span><span class="nn">HtmlHelper</span><span class="p">.</span><span class="n">toggleClass</span> <span class="s2">"is-hidden"</span><span class="p">)</span>
</code></pre></div></div>

<h4 id="step-3b-saving-scroll-position">Step 3b. Saving scroll position</h4>

<p>If we try out the application now, we can see that adding and removing adds works… but if we scroll the page it jumps back to the top every time we make an edit:</p>

<p><img src="/assets/images/safe-turbolinks-scroll-position.gif" alt="without storing scroll position" /></p>

<p>This is caused by the call to <code class="highlighter-rouge">Turbolinks.visit()</code>. To fix this we can add a <a href="https://github.com/viktorvan/safe-stack-turbolinks-demo/blob/master/src/Client/ScrollPositionService.fs">helper</a> to save and recall the scroll position:</p>

<div class="language-fsharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// ScrollPositionService.fs</span>
<span class="k">open</span> <span class="nc">Browser</span>

<span class="k">type</span> <span class="nc">ScrollPositionService</span><span class="bp">()</span> <span class="p">=</span>
    <span class="k">let</span> <span class="k">mutable</span> <span class="n">scrollPosition</span> <span class="p">=</span> <span class="nc">None</span>
    <span class="k">member</span> <span class="n">this</span><span class="p">.</span><span class="nc">Save</span><span class="bp">()</span> <span class="p">=</span>
        <span class="n">scrollPosition</span> <span class="p">&lt;-</span> <span class="nc">Some</span> <span class="o">{|</span> <span class="nc">X</span> <span class="p">=</span> <span class="n">window</span><span class="p">.</span><span class="n">scrollX</span><span class="p">;</span> <span class="nc">Y</span> <span class="p">=</span> <span class="n">window</span><span class="p">.</span><span class="n">scrollY</span> <span class="o">|}</span>
    <span class="k">member</span> <span class="n">this</span><span class="p">.</span><span class="nc">Recall</span><span class="bp">()</span> <span class="p">=</span>
        <span class="n">scrollPosition</span>
        <span class="p">|&gt;</span> <span class="nn">Option</span><span class="p">.</span><span class="n">iter</span> <span class="p">(</span><span class="k">fun</span> <span class="n">p</span> <span class="p">-&gt;</span> <span class="n">window</span><span class="p">.</span><span class="n">scrollTo</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="nc">X</span><span class="p">,</span> <span class="n">p</span><span class="p">.</span><span class="nc">Y</span><span class="o">))</span>
        <span class="n">scrollPosition</span> <span class="p">&lt;-</span> <span class="nc">None</span>
</code></pre></div></div>

<p>And we hook into another custom Turbolinks event “turbolinks:before-cache” to save the scroll position, then recall it in “turbolinks:load”:</p>

<div class="language-fsharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// App.fs</span>

<span class="n">document</span><span class="p">.</span><span class="n">addEventListener</span><span class="p">(</span><span class="s2">"turbolinks:before-cache"</span><span class="p">,</span> <span class="k">fun</span> <span class="p">_</span> <span class="p">-&gt;</span>
    <span class="nn">CompositionRoot</span><span class="p">.</span><span class="n">scrollPositionService</span><span class="p">.</span><span class="nc">Save</span><span class="bp">()</span><span class="p">)</span>

<span class="n">document</span><span class="p">.</span><span class="n">addEventListener</span><span class="p">(</span><span class="s2">"turbolinks:load"</span><span class="p">,</span> <span class="k">fun</span> <span class="p">_</span> <span class="p">-&gt;</span>
    <span class="nn">CompositionRoot</span><span class="p">.</span><span class="n">scrollPositionService</span><span class="p">.</span><span class="nc">Recall</span><span class="bp">()</span>
    <span class="nn">Datepicker</span><span class="p">.</span><span class="n">init</span> <span class="bp">()</span><span class="p">)</span>
<span class="p">)</span>
</code></pre></div></div>

<p>And voilà, the page no longer jumps to the top when we add or remove eggs.</p>

<h3 id="step-4-deal-with-redirects">Step 4. Deal with redirects</h3>

<p>One last thing.</p>

<p>If we click on the link “ChickenCheck” in the navbar we are taken back to the root of the home page. On the server this will redirect us to the chickens page for the current date <code class="highlighter-rouge">/chickens/date?&lt;currentDate&gt;</code>. If we try it we can see that the url in our browser stays at the root of the homepage. This is expected, <a href="https://github.com/turbolinks/turbolinks#following-redirects">from the documentation</a>: “Turbolinks makes requests using XMLHttpRequest, which transparently follows redirects. There’s no way for Turbolinks to tell whether a request resulted in a redirect without additional cooperation from the server.”</p>

<p>To fix this we need to add a custom response header “Turbolinks-Location” to all requests initiated by Turbolinks (with request header “Turbolinks-Referrer”). Turbolinks will then replace the last entry in the browser history with this value. So in our server setup we add this code:</p>

<div class="language-fsharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Server.fs</span>
<span class="k">let</span> <span class="n">setTurbolinksLocationHeader</span> <span class="p">:</span> <span class="nc">HttpHandler</span> <span class="p">=</span>
    <span class="k">let</span> <span class="n">isTurbolink</span> <span class="p">(</span><span class="n">ctx</span><span class="p">:</span> <span class="nc">HttpContext</span><span class="p">)</span> <span class="p">=</span>
        <span class="n">ctx</span><span class="p">.</span><span class="nn">Request</span><span class="p">.</span><span class="nn">Headers</span><span class="p">.</span><span class="nc">ContainsKey</span> <span class="s2">"Turbolinks-Referrer"</span>

    <span class="k">fun</span> <span class="n">next</span> <span class="n">ctx</span> <span class="p">-&gt;</span>
        <span class="n">task</span> <span class="p">{</span>
            <span class="k">if</span> <span class="n">isTurbolink</span> <span class="n">ctx</span> <span class="k">then</span>
                <span class="n">ctx</span><span class="p">.</span><span class="nc">SetHttpHeader</span> <span class="s2">"Turbolinks-Location"</span> <span class="p">(</span><span class="n">ctx</span><span class="p">.</span><span class="nn">Request</span><span class="p">.</span><span class="nc">Path</span> <span class="o">+</span> <span class="n">ctx</span><span class="p">.</span><span class="nn">Request</span><span class="p">.</span><span class="nc">QueryString</span><span class="p">)</span>
            <span class="k">return</span><span class="o">!</span> <span class="n">next</span> <span class="n">ctx</span>
        <span class="p">}</span>
</code></pre></div></div>

<p>And add this httphandler to our server pipeline. Since I am using Saturn I can do this by “plugging” it into my endpointPipeline:</p>

<div class="language-fsharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">let</span> <span class="n">endpointPipe</span> <span class="p">=</span> <span class="n">pipeline</span> <span class="p">{</span>
    <span class="n">plug</span> <span class="n">putSecureBrowserHeaders</span>
    <span class="n">plug</span> <span class="n">head</span>
    <span class="n">plug</span> <span class="n">setTurbolinksLocationHeader</span>
<span class="p">}</span>
</code></pre></div></div>

<p>And we’re done!</p>

<h3 id="conclusions">Conclusions</h3>

<p>In this small application I feel that using Turbolinks greatly simplified my code. I could get rid of a lot of Elmish boiler-plate, Models and Messages. And I only needed to deal with rendering html in one place in the server where I had all information readily available. In the elmish application I had to deal with several kinds of updates to the views, e.g. The user changed date -&gt; fetch new eggCount and update the view; The user added an egg -&gt; update the eggCount for the correct chicken view + update the total count in the statistics section.
Albeit we had to add some event listener setup, but with the Active Patterns I feel it turned out pretty clean.</p>

<p>With that said I think there absolutely are use cases, i.e. apps with a lot going on at the client side, where I would prefer to use Elmish, or <a href="https://zaid-ajaj.github.io/Feliz/#/Hooks/UseElmish">Feliz.UseElmish</a>.</p>

<div class="footnotes">
  <ol>
    <li id="fn:1">
      <p>If you want Turbolinks to handle redirects (i.e. if you expect a redirect on the server to also update the url in the browser) you need to add a middleware that sets a <a href="https://github.com/turbolinks/turbolinks#following-redirects">Turbolinks specific header</a> so it knows what location it is supposed to be at. For Ruby on Rails there is a <a href="https://github.com/turbolinks/turbolinks-rails">Turbolinks RubyGem</a> available that already does this for you. We will deal with this in step 4. <a href="#fnref:1" class="reversefootnote">&#8617;</a></p>
    </li>
    <li id="fn:2">
      <p>We could also implement this functionality with a query string parameter, e.g. ?expandMenu=true, and then render the menu expanded in the html returned from the server. But for the sake of this example, let’s do it with javascript. <a href="#fnref:2" class="reversefootnote">&#8617;</a></p>
    </li>
    <li id="fn:3">
      <p>I have simplified the optimization section to only generate two chunks, to make it easier to include in this demo application. In a production setting you may want to split your vendor scripts into separate chunks, and use [contenthash] in the bundle names to be able to do cache busting. If you go that route you need to look at the generated webpack manifest and include your bundles in the correct order in your html head. But it’s out of scope of this blog post. <a href="#fnref:3" class="reversefootnote">&#8617;</a></p>
    </li>
    <li id="fn:4">
      <p>The element also needs to have an id. <a href="#fnref:4" class="reversefootnote">&#8617;</a></p>
    </li>
    <li id="fn:5">
      <p>We need to deal with some different cases when we need to attach the Bulma.Calendar javascript, depending on if we are navigating “by links” or by using the “back” and “forward” buttons of the browser. See the <a href="https://github.com/viktorvan/safe-stack-turbolinks-demo/blob/master/src/Client/DatePicker.fs">full solution</a> for all details. <a href="#fnref:5" class="reversefootnote">&#8617;</a></p>
    </li>
  </ol>
</div>

        
      </section>

      <footer class="page__meta">
        
        
  


  
  
  

  <p class="page__taxonomy">
    <strong><i class="fas fa-fw fa-tags" aria-hidden="true"></i> Tags: </strong>
    <span itemprop="keywords">
    
      
      
      <a href="/tags/#fsharp" class="page__taxonomy-item" rel="tag">fsharp</a><span class="sep">, </span>
    
      
      
      <a href="/tags/#turbolinks" class="page__taxonomy-item" rel="tag">turbolinks</a><span class="sep">, </span>
    
      
      
      <a href="/tags/#web" class="page__taxonomy-item" rel="tag">web</a>
    
    </span>
  </p>




  


  
  
  

  <p class="page__taxonomy">
    <strong><i class="fas fa-fw fa-folder-open" aria-hidden="true"></i> Categories: </strong>
    <span itemprop="keywords">
    
      
      
      <a href="/categories/#fsharp" class="page__taxonomy-item" rel="tag">fsharp</a>
    
    </span>
  </p>


        
  <p class="page__date"><strong><i class="fas fa-fw fa-calendar-alt" aria-hidden="true"></i> Updated:</strong> <time datetime="2020-07-22T17:00:00+02:00">July 22, 2020</time></p>


      </footer>

      <section class="page__share">
  

  <a href="https://twitter.com/intent/tweet?via=Emmet_Ray&text=Using+Turbolinks+with+the+SAFE+web+stack%20https%3A%2F%2Fviktorvan.github.io%2Ffsharp%2Fsafe-stack-turbolinks%2F" class="btn btn--twitter" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on Twitter"><i class="fab fa-fw fa-twitter" aria-hidden="true"></i><span> Twitter</span></a>

  <a href="https://www.facebook.com/sharer/sharer.php?u=https%3A%2F%2Fviktorvan.github.io%2Ffsharp%2Fsafe-stack-turbolinks%2F" class="btn btn--facebook" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on Facebook"><i class="fab fa-fw fa-facebook" aria-hidden="true"></i><span> Facebook</span></a>

  <a href="https://www.linkedin.com/shareArticle?mini=true&url=https%3A%2F%2Fviktorvan.github.io%2Ffsharp%2Fsafe-stack-turbolinks%2F" class="btn btn--linkedin" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on LinkedIn"><i class="fab fa-fw fa-linkedin" aria-hidden="true"></i><span> LinkedIn</span></a>
</section>


      
  <nav class="pagination">
    
      <a href="/fsharp/migrating-activelogin.identity-to-property-based-tests-4/" class="pagination--pager" title="Migrating a C# test suite to property based tests in F# - part 4
">Previous</a>
    
    
      <a href="/kubernetes/kubernetes-on-raspberry-pi/" class="pagination--pager" title="Running kubernetes on Raspberry Pi
">Next</a>
    
  </nav>

    </div>

    
  </article>

  
  
    <div class="page__related">
      <h4 class="page__related-title">You May Also Enjoy</h4>
      <div class="grid__wrapper">
        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/kubernetes/kubernetes-on-raspberry-pi/" rel="permalink">Running kubernetes on Raspberry Pi
</a>
      
    </h2>
    

  <p class="page__meta">
    

    

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          7 minute read
        
      </span>
    
  </p>


    <p class="archive__item-excerpt" itemprop="description">“Do you really need a cloud for that?”
or: How I spent my 2020 summer vacation

</p>
  </article>
</div>

        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/fsharp/migrating-activelogin.identity-to-property-based-tests-4/" rel="permalink">Migrating a C# test suite to property based tests in F# - part 4
</a>
      
    </h2>
    

  <p class="page__meta">
    

    

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          11 minute read
        
      </span>
    
  </p>


    <p class="archive__item-excerpt" itemprop="description">Property based tests part 4 - production code repeated in tests.

</p>
  </article>
</div>

        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/fsharp/migrating-activelogin.identity-to-property-based-tests-3/" rel="permalink">Migrating a C# test suite to property based tests in F# - part 3
</a>
      
    </h2>
    

  <p class="page__meta">
    

    

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          8 minute read
        
      </span>
    
  </p>


    <p class="archive__item-excerpt" itemprop="description">Property based tests part 3 - generators with too many output values.

</p>
  </article>
</div>

        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/fsharp/migrating-activelogin.identity-to-property-based-tests-2/" rel="permalink">Migrating a C# test suite to property based tests in F# - part 2
</a>
      
    </h2>
    

  <p class="page__meta">
    

    

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          8 minute read
        
      </span>
    
  </p>


    <p class="archive__item-excerpt" itemprop="description">Property based tests part 2 - More about generators.

</p>
  </article>
</div>

        
      </div>
    </div>
  
  
</div>

    </div>

    

    <div id="footer" class="page__footer">
      <footer>
        <!-- start custom footer snippets -->
<!-- <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/cookieconsent@3/build/cookieconsent.min.css" />

<script src="https://cdn.jsdelivr.net/npm/cookieconsent@3/build/cookieconsent.min.js" data-cfasync="false"></script>
<script>
window.cookieconsent.initialise({
  "palette": {
    "popup": {
      "background": "#343c66",
      "text": "#cfcfe8"
    },
    "button": {
      "background": "transparent",
      "text": "#f71559",
      "border": "#f71559"
    }
  },
  "position": "bottom-right"
}); -->
<!-- </script> -->
<!-- end custom footer snippets -->
        <div class="page__footer-follow">
  <ul class="social-icons">
    

    
      
        
          <li><a href="https://twitter.com/Emmet_Ray" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-twitter-square" aria-hidden="true"></i> Twitter</a></li>
        
      
        
      
        
      
        
      
        
      
        
      
        
          <li><a href="/terms" rel="nofollow noopener noreferrer"><i class="fas fa-link" aria-hidden="true"></i> Privacy policy</a></li>
        
      
    

    <li><a href="/feed.xml"><i class="fas fa-fw fa-rss-square" aria-hidden="true"></i> Feed</a></li>
  </ul>
</div>

<div class="page__footer-copyright">&copy; 2020 Viktor Andersson. Powered by <a href="https://jekyllrb.com" rel="nofollow">Jekyll</a> &amp; <a href="https://mademistakes.com/work/minimal-mistakes-jekyll-theme/" rel="nofollow">Minimal Mistakes</a>.</div>

      </footer>
    </div>

    
  <script src="/assets/js/main.min.js"></script>










  </body>
</html>
