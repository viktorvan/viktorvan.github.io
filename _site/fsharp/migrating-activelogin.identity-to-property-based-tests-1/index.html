<!doctype html>
<!--
  Minimal Mistakes Jekyll Theme 4.16.6 by Michael Rose
  Copyright 2013-2019 Michael Rose - mademistakes.com | @mmistakes
  Free for personal and commercial use under the MIT license
  https://github.com/mmistakes/minimal-mistakes/blob/master/LICENSE
-->
<html lang="en" class="no-js">
  <head>
    <meta charset="utf-8">

<!-- begin _includes/seo.html --><title>Migrating a C# test suite to property based tests in F# - part 1 - Viktor Andersson</title>
<meta name="description" content="Background">


  <meta name="author" content="Viktor Andersson">


<meta property="og:type" content="article">
<meta property="og:locale" content="en_US">
<meta property="og:site_name" content="Viktor Andersson">
<meta property="og:title" content="Migrating a C# test suite to property based tests in F# - part 1">
<meta property="og:url" content="https://viktorvan.github.io/fsharp/migrating-activelogin.identity-to-property-based-tests-1/">


  <meta property="og:description" content="Background">



  <meta property="og:image" content="https://viktorvan.github.io/assets/images/sansebastian1.jpg">



  <meta name="twitter:site" content="@Emmet_Ray">
  <meta name="twitter:title" content="Migrating a C# test suite to property based tests in F# - part 1">
  <meta name="twitter:description" content="Background">
  <meta name="twitter:url" content="https://viktorvan.github.io/fsharp/migrating-activelogin.identity-to-property-based-tests-1/">

  
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:image" content="https://viktorvan.github.io/assets/images/sansebastian1.jpg">
  

  



  <meta property="article:published_time" content="2019-08-12T07:45:00+02:00">





  

  


<link rel="canonical" href="https://viktorvan.github.io/fsharp/migrating-activelogin.identity-to-property-based-tests-1/">




<script type="application/ld+json">
  {
    "@context": "https://schema.org",
    
      "@type": "Person",
      "name": "Viktor Andersson",
      "url": "https://viktorvan.github.io/"
    
  }
</script>






<!-- end _includes/seo.html -->


<link href="/feed.xml" type="application/atom+xml" rel="alternate" title="Viktor Andersson Feed">

<!-- https://t.co/dKP3o1e -->
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script>
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
</script>

<!-- For all browsers -->
<link rel="stylesheet" href="/assets/css/main.css">

<!--[if IE ]>
  <style>
    /* old IE unsupported flexbox fixes */
    .greedy-nav .site-title {
      padding-right: 3em;
    }
    .greedy-nav button {
      position: absolute;
      top: 0;
      right: 0;
      height: 100%;
    }
  </style>
<![endif]-->



    <!-- start custom head snippets -->

<!-- insert favicons. use https://realfavicongenerator.net/ -->

<!-- end custom head snippets -->

  </head>

  <body class="layout--single wide">
    <nav class="skip-links">
  <h2 class="screen-reader-text">Skip links</h2>
  <ul>
    <li><a href="#site-nav" class="screen-reader-shortcut">Skip to primary navigation</a></li>
    <li><a href="#main" class="screen-reader-shortcut">Skip to content</a></li>
    <li><a href="#footer" class="screen-reader-shortcut">Skip to footer</a></li>
  </ul>
</nav>

    <!--[if lt IE 9]>
<div class="notice--danger align-center" style="margin: 0;">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience.</div>
<![endif]-->

    

<div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="greedy-nav">
        
        <a class="site-title" href="/">
          Viktor Andersson
          
        </a>
        <ul class="visible-links"><li class="masthead__menu-item">
              <a href="" >Tags</a>
            </li><li class="masthead__menu-item">
              <a href="/tags/" ></a>
            </li></ul>
        
        <button class="greedy-nav__toggle hidden" type="button">
          <span class="visually-hidden">Toggle menu</span>
          <div class="navicon"></div>
        </button>
        <ul class="hidden-links hidden"></ul>
      </nav>
    </div>
  </div>
</div>


    <div class="initial-content">
      
  











<div class="page__hero--overlay"
  style=" background-image: url('/assets/images/sansebastian1.jpg');"
>
  
    <div class="wrapper">
      <h1 id="page-title" class="page__title" itemprop="headline">
        
          Migrating a C# test suite to property based tests in F# - part 1

        
      </h1>
      
        <p class="page__lead"><h1 id="background">Background</h1>

</p>
      
      
        <p class="page__meta"><i class="far fa-clock" aria-hidden="true"></i> 




  13 minute read
</p>
      
      
      
    </div>
  
  
</div>





<div id="main" role="main">
  
  <div class="sidebar sticky">
  


<div itemscope itemtype="https://schema.org/Person">

  
    <div class="author__avatar">
      

      
        <img src="/assets/images/bio-photo.jpg" alt="Viktor Andersson" itemprop="image">
      
    </div>
  

  <div class="author__content">
    
      <h3 class="author__name" itemprop="name">Viktor Andersson</h3>
    
    
      <div class="author__bio" itemprop="description">
        <p>Software developer, beekeeper and F# enthusiast</p>

      </div>
    
  </div>

  <div class="author__urls-wrapper">
    <button class="btn btn--inverse">Follow</button>
    <ul class="author__urls social-icons">
      
        <li itemprop="homeLocation" itemscope itemtype="https://schema.org/Place">
          <i class="fas fa-fw fa-map-marker-alt" aria-hidden="true"></i> <span itemprop="name">Stockholm, Sweden</span>
        </li>
      

      
        
          
            <li><a href="mailto:v.andersson@me.com" rel="nofollow noopener noreferrer"><i class="fas fa-fw fa-envelope-square" aria-hidden="true"></i> Email</a></li>
          
        
          
        
          
            <li><a href="https://twitter.com/Emmet_Ray" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-twitter-square" aria-hidden="true"></i> Twitter</a></li>
          
        
          
        
          
            <li><a href="https://github.com/viktorvan" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-github" aria-hidden="true"></i> GitHub</a></li>
          
        
          
        
          
            <li><a href="https://www.linkedin.com/in/viktorand/" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-linkedin" aria-hidden="true"></i> LinkedIn</a></li>
          
        
      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      <!--
  <li>
    <a href="http://link-to-whatever-social-network.com/user/" itemprop="sameAs" rel="nofollow noopener noreferrer">
      <i class="fas fa-fw" aria-hidden="true"></i> Custom Social Profile Link
    </a>
  </li>
-->
    </ul>
  </div>
</div>

  
  </div>


  <article class="page" itemscope itemtype="https://schema.org/CreativeWork">
    <meta itemprop="headline" content="Migrating a C# test suite to property based tests in F# - part 1">
    <meta itemprop="description" content="Background">
    <meta itemprop="datePublished" content="August 12, 2019">
    

    <div class="page__inner-wrap">
      

      <section class="page__content" itemprop="text">
        
          <aside class="sidebar__right ">
            <nav class="toc">
              <header><h4 class="nav__title"><i class="fas fa-file-alt"></i> On this page</h4></header>
              <ul class="toc__menu">
  <li><a href="#background">Background</a></li>
  <li><a href="#what-are-property-based-tests">What are property-based tests</a>
    <ul>
      <li><a href="#testing-by-example">Testing by example</a></li>
      <li><a href="#testing-by-properties">Testing by properties</a></li>
      <li><a href="#unit-testing-in-f">Unit testing in F#</a></li>
    </ul>
  </li>
  <li><a href="#testing-the-parse-function">Testing the parse function</a>
    <ul>
      <li><a href="#the-happy-path-parsing-valid-pin-strings">The Happy Path: Parsing valid pin strings</a></li>
      <li><a href="#creating-a-custom-generator-for-the-swedishpersonalidentitynumber-type">Creating a custom generator for the SwedishPersonalIdentityNumber type</a></li>
      <li><a href="#using-our-custom-generator">Using our custom generator</a></li>
      <li><a href="#adding-type-safety-to-our-generators">Adding type safety to our generators</a></li>
      <li><a href="#valid-10-digit-strings">Valid 10 digit strings</a></li>
      <li><a href="#other-valid-pin-strings">Other valid pin strings</a>
        <ul>
          <li><a href="#12-digit-strings-with-extra-noise">12 digit strings with extra “noise”</a></li>
          <li><a href="#conclusion">Conclusion</a></li>
        </ul>
      </li>
    </ul>
  </li>
</ul>
            </nav>
          </aside>
        
        <h1 id="background">Background</h1>

<p>I’ve been wanting to try property-based testing in a real-life situation for some time, and decided to try it out with the test suite for our open source library <a href="https://github.com/ActiveLogin/ActiveLogin.Identity">ActiveLogin.Identity</a>.</p>

<p>A short background on ActiveLogin.Identity; it’s a library for parsing and validating Swedish identities, such as a Personal Identity Number, let’s call it a <strong>pin</strong>. For this blog we can be satisfied with the following simplified model: the format for a pin is YYYYMMDDBBBC, i.e. <strong>Y</strong>ear, <strong>M</strong>onth, <strong>D</strong>ay, <strong>B</strong>irth number and a <strong>C</strong>hecksum. The birth number is any number three digit number from 001 to 999, the checksum is calculated using the <a href="https://en.wikipedia.org/wiki/Luhn_algorithm">Luhn algorithm</a>. You can also write a pin using a 10 digit format YYMMDD-BBBC or YYMMDD+BBBC, where a “+” indicates that the person has turned or is turning 100 this year<sup id="fnref:1"><a href="#fn:1" class="footnote">1</a></sup>.</p>

<p>There are a few functions of interest in the library that we are going to focus on in this blog post: <code class="highlighter-rouge">parse</code>, <code class="highlighter-rouge">to12DigitString</code>, and <code class="highlighter-rouge">to10DigitString</code>. What they do is pretty straight forward, <code class="highlighter-rouge">parse</code> takes a string input and returns a pin or an error. The <code class="highlighter-rouge">toXXDigitString</code> takes a pin and returns its string representation.</p>

<h1 id="what-are-property-based-tests">What are property-based tests</h1>
<h2 id="testing-by-example">Testing by example</h2>
<p>So what are property-based tests? Maybe it is easier to explain if put them in contrast with <em>normal</em> unit tests. The first test from the original code looks like this:</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">[Theory]</span>
<span class="na">[InlineData("990913+9801", 1899)]</span>
<span class="na">[InlineData("120211+9986", 1912)]</span>
<span class="na">[InlineData("990807-2391", 1999)]</span>
<span class="na">[InlineData("180101-2392", 2018)]</span>
<span class="k">public</span> <span class="k">void</span> <span class="nf">Parses_Year_From_10_Digit_String</span><span class="p">(</span>
    <span class="kt">string</span> <span class="n">personalIdentityNumberString</span><span class="p">,</span> 
    <span class="kt">int</span> <span class="n">expectedYear</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">var</span> <span class="n">personalIdentityNumber</span> <span class="p">=</span> 
        <span class="n">SwedishPersonalIdentityNumber</span><span class="p">.</span><span class="nf">Parse</span><span class="p">(</span><span class="n">personalIdentityNumberString</span><span class="p">);</span>
    <span class="n">Assert</span><span class="p">.</span><span class="nf">Equal</span><span class="p">(</span><span class="n">expectedYear</span><span class="p">,</span> <span class="n">personalIdentityNumber</span><span class="p">.</span><span class="n">Year</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>This looks like a normal unit test and is what we can call an <strong>example-based test</strong>. We are providing the tests with four known <strong>example</strong> inputs (through the InlineData attributes) that we expect to have a certain outcome. In this case we expect the <code class="highlighter-rouge">SwedishPersonalIdentityNumber.Parse</code> method to correctly parse the year part of the pin.</p>

<p>But we are only testing with four inputs which is only a small subset of the actual inputs we can expect.</p>

<h2 id="testing-by-properties">Testing by properties</h2>

<p>Property-based testing turns this on its head. Instead of us, the test writers, providing the example inputs, we let a library do it using a <em>generators</em>. In the simplest case this could just be a generator that returns a random integer. For our domain types we usually have to write our own custom generators.</p>

<p>The testing library would then run our tests several times using input from the <em>generator</em>. Either it will find an input where the test fails and report that to us, or after running the tests a certain number of times it would be satisfied that the <em>property</em> holds.</p>

<p>We call these tests property-based since instead of providing <em>example inputs</em> where we know the result, we will be stating <em>properties</em> about the code we are testing.</p>

<p>Often these property tests can look quite different from what (at least from my experience) unit tests normally look like. For example when it comes to testing the parse function that is tested above I ended up with a series of tests that actually are testing parse and the toXXDigitString functions together:
One example property would be, in plain english: “turning a pin into a 12-digit string and then parsing it, should return the same pin”. And this is what the property-based test in F# would look like:</p>

<div class="language-fsharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="n">testProp</span> <span class="s2">"roundtrip for 12 digit string"</span> <span class="p">&lt;|</span> <span class="k">fun</span> <span class="p">(</span><span class="nn">Gen</span><span class="p">.</span><span class="nc">ValidPin</span> <span class="n">pin</span><span class="p">)</span> <span class="p">-&gt;</span>
        <span class="n">pin</span>
        <span class="p">|&gt;</span> <span class="nn">SwedishPersonalIdentityNumber</span><span class="p">.</span><span class="n">to12DigitString</span>
        <span class="p">|&gt;</span> <span class="nn">SwedishPersonalIdentityNumber</span><span class="p">.</span><span class="n">parse</span> <span class="o">=!</span> <span class="nc">Ok</span> <span class="n">pin</span>
</code></pre></div></div>

<p>But that’s probably a lot to take in if you’re not familiar with F# or unit testing in F#.</p>

<h2 id="unit-testing-in-f">Unit testing in F#</h2>

<p>The tests we are migrating from are written against the C# api of the library. Since there now is an F# implementation of the api I will be writing the new tests against the F# api.
A quick note on writing unit tests in F#. My test library of choice for F# is <a href="https://github.com/haf/expecto">Expecto</a>. I also like <a href="https://github.com/SwensenSoftware/unquote">Unquote</a> for writing my assertions, since I think it makes for really expressive assertions.</p>

<p>For those unfamiliar with Unquote it makes it possible to write test assertions using F# quotations. For example, the following Expecto assertion:</p>

<div class="language-fsharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">let</span> <span class="n">result</span> <span class="p">=</span> <span class="mi">17</span>
<span class="nn">Expect</span><span class="p">.</span><span class="n">equal</span> <span class="n">result</span> <span class="mi">42</span> <span class="s2">"result should be equal to 42"</span>
<span class="c1">// outputs:</span>
<span class="c1">// result should be equal to 42.</span>
<span class="c1">// expected: 42</span>
<span class="c1">// actual: 17</span>
</code></pre></div></div>

<p>could with Unquote be written as:</p>

<div class="language-fsharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">let</span> <span class="n">result</span> <span class="p">=</span> <span class="mi">17</span>
<span class="n">test</span> <span class="o">&lt;@</span> <span class="n">result</span> <span class="p">=</span> <span class="mi">42</span> <span class="o">@&gt;</span>
<span class="c1">// outputs:</span>
<span class="c1">// 17 = 42</span>
<span class="c1">// false</span>
</code></pre></div></div>

<p>or even simpler, using one of Unquote’s custom operators:</p>

<div class="language-fsharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">let</span> <span class="n">result</span> <span class="p">=</span> <span class="mi">17</span>
<span class="n">result</span> <span class="o">=!</span> <span class="mi">42</span>
<span class="c1">// outputs:</span>
<span class="c1">// 17 = 42</span>
<span class="c1">// false</span>
</code></pre></div></div>

<p>The library we are going to use for property-based testing is <a href="https://fscheck.github.io/FsCheck/">FsCheck</a>. Expecto has an api for writing property-based tests with FsCheck so we will use that. Both FsCheck and Expecto can also be used from C#.</p>

<h1 id="testing-the-parse-function">Testing the parse function</h1>

<p>The first function we will test is <code class="highlighter-rouge">parse</code>.</p>

<div class="language-fsharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// string -&gt; Result&lt;SwedishPersonalIdentityNumber, Error&gt;</span>
<span class="k">let</span> <span class="n">parse</span> <span class="n">str</span> <span class="p">=</span> <span class="o">...</span>
</code></pre></div></div>

<p>where <code class="highlighter-rouge">Error</code> is a discriminated union with some error cases specific to our domain.</p>

<p>So it’s a function that given a string input will return a value wrapped in the built-in <code class="highlighter-rouge">Result</code>type. Result is a discriminated union that can have either an <code class="highlighter-rouge">Ok</code> value or an <code class="highlighter-rouge">Error</code>. In the F# api we are not throwing any exceptions like we did in the C# api.</p>

<h2 id="the-happy-path-parsing-valid-pin-strings">The Happy Path: Parsing valid pin strings</h2>
<p>In the original C# code we have several tests to verify that we can parse a valid pin. The idea is to replace them with a few of the “roundtrip” tests described above.</p>

<p>The first one is:</p>
<div class="language-fsharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">testProp</span> <span class="s2">"roundtrip for 12 digit string"</span> <span class="p">&lt;|</span> <span class="k">fun</span> <span class="n">pin</span> <span class="p">-&gt;</span>
    <span class="n">pin</span>
    <span class="p">|&gt;</span> <span class="nn">SwedishPersonalIdentityNumber</span><span class="p">.</span><span class="n">to12DigitString</span>
    <span class="p">|&gt;</span> <span class="nn">SwedishPersonalIdentityNumber</span><span class="p">.</span><span class="n">parse</span> <span class="o">=!</span> <span class="nc">Ok</span> <span class="n">pin</span>
</code></pre></div></div>

<p>I.e. given a valid pin, if we turn it in to a 12 digit string and parse it again, we should get the same pin back. If we try to run this test we get an ArgumentException:</p>

<div class="notice--danger">
    [16:10:45 INF] EXPECTO? Running tests...<br />
    [16:10:46 ERR] parse/valid pins/roundtrip for 12 digit string errored in 00:00:00.4420000 <br />
    System.ArgumentException: The type 'ActiveLogin.Identity.Swedish.FSharp.Types+Year' is an F# union type but its representation is private. You must specify BindingFlags.NonPublic to access private type representations. <br />
    [16:10:46 INF] EXPECTO! 1 tests run in 00:00:00.5820007 for miscellaneous – 0 passed, 0 ignored, 0 failed, 1 errored.
</div>

<p>Which is due to the fact that FsCheck doesn’t yet know how to create the input <code class="highlighter-rouge">pin</code> for us<sup id="fnref:2"><a href="#fn:2" class="footnote">2</a></sup>. We need to write custom generator.</p>

<h2 id="creating-a-custom-generator-for-the-swedishpersonalidentitynumber-type">Creating a custom generator for the SwedishPersonalIdentityNumber type</h2>

<p>It turns out, due to GDPR, that you should not use any ‘real’ Personal Identity Number values in your tests since the pins could actully belong to a real person. The Swedish National Tax Board that is in charge of the Personal Identity Numbers actually provide a list of valid numbers to use for testing purposes. To simplify the usage of these test numbers <a href="https://github.com/ActiveLogin/ActiveLogin.Identity">ActiveLogin.Identity</a> actually provides access to the test numbers in the package <a href="https://www.nuget.org/packages/ActiveLogin.Identity.Swedish.TestData/"><code class="highlighter-rouge">ActiveLogin.Identity.Swedish.TestData</code></a>. So we’ll use that package to ensure we are not using any ‘real’ pin numbers.</p>

<p>Using the TestData package we can get a random valid pin from: <code class="highlighter-rouge">SwedishPersonalIdentityNumberTestData.getRandom()</code>.
Now let’s build our custom generator; In this case it is quite easy, we can use the generator computation expression from FsCheck and just call the getRandom-function.</p>

<div class="language-fsharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Gen&lt;SwedishPersonalIdentityNumber&gt;</span>
<span class="k">let</span> <span class="n">validPin</span><span class="bp">()</span> <span class="p">=</span> <span class="n">gen</span> <span class="p">{</span> <span class="k">return</span> <span class="nn">SwedishPersonalIdentityNumberTestData</span><span class="p">.</span><span class="n">getRandom</span><span class="bp">()</span> <span class="p">}</span>
</code></pre></div></div>

<p>FsCheck actually packages a <em>generator</em> together with a <em>shrinker</em> into something called an <em>arbitrary</em> instance. The <em>shrinker</em> has the following signature: <code class="highlighter-rouge">'a -&gt; seq&lt;'a&gt;</code> and takes an input and returns new values of the same type that are in some way ‘smaller’ that the original value. The <em>shrinker</em> is used when a test fails. FsCheck will then use the shrink the input and try again until it finds the smallest value that will cause the property to fail.
I will not go further into the details of those concepts in this blog post, but feel free to take a deep dive into <a href="https://fscheck.github.io/FsCheck/TestData.html">FsCheck’s documentation on generating test data</a>. We actually don’t have to provide a shrinker, but we have to wrap our generator in the Arbitrary type like this:</p>

<div class="language-fsharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Arbitrary&lt;SwedishPersonalIdentityNumber&gt;</span>
<span class="k">let</span> <span class="n">validPin</span><span class="bp">()</span> <span class="p">=</span> <span class="n">gen</span> <span class="p">{</span> 
    <span class="k">return</span> <span class="nn">SwedishPersonalIdentityNumberTestData</span><span class="p">.</span><span class="n">getRandom</span><span class="bp">()</span> <span class="p">}</span> 
    <span class="p">|&gt;</span> <span class="nn">Arb</span><span class="p">.</span><span class="n">fromGen</span>
</code></pre></div></div>

<h2 id="using-our-custom-generator">Using our custom generator</h2>

<p>To use the generator we need to configure Expecto to use it.</p>

<div class="language-fsharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">type</span> <span class="nc">IdentityNumberGenerators</span><span class="bp">()</span> <span class="p">=</span>
    <span class="k">static</span> <span class="k">member</span> <span class="nc">ValidPin</span><span class="bp">()</span> <span class="p">:</span> <span class="nc">Arbitrary</span><span class="p">&lt;</span><span class="nc">SwedishPersonalIdentityNumberValues</span><span class="p">&gt;</span> <span class="p">=</span> <span class="n">validPin</span><span class="bp">()</span>
</code></pre></div></div>

<div class="language-fsharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">let</span> <span class="n">config</span> <span class="p">=</span> 
    <span class="p">{</span> <span class="nn">FsCheckConfig</span><span class="p">.</span><span class="n">defaultConfig</span> <span class="k">with</span> <span class="n">arbitrary</span> <span class="p">=</span> <span class="p">[</span> <span class="n">typeof</span><span class="p">&lt;</span><span class="nc">IdentityNumberGenerators</span><span class="p">&gt;</span> <span class="p">]</span> <span class="p">}</span> 

<span class="n">testPropertyWithConfig</span> <span class="n">config</span> <span class="s2">"roundtrip for 12 digit string"</span> <span class="p">&lt;|</span> <span class="k">fun</span> <span class="n">pin</span> <span class="p">-&gt;</span>
    <span class="n">pin</span>
    <span class="p">|&gt;</span> <span class="nn">SwedishPersonalIdentityNumber</span><span class="p">.</span><span class="n">to12DigitString</span>
    <span class="p">|&gt;</span> <span class="nn">SwedishPersonalIdentityNumber</span><span class="p">.</span><span class="n">parse</span> <span class="o">=!</span> <span class="nc">Ok</span> <span class="n">pin</span>
</code></pre></div></div>

<p>We can run that test and now it will pass:</p>

<div class="notice--success">
    [17:25:26 INF] EXPECTO? Running tests...<br />
    [17:25:27 INF] EXPECTO! 1 tests run in 00:00:01.0833124 for miscellaneous – 1 passed, 0 ignored, 0 failed, 0 errored. Success!
</div>

<p>Let’s refactor the test and add a helper function.</p>

<div class="language-fsharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">let</span> <span class="n">config</span> <span class="p">=</span> 
    <span class="p">{</span> <span class="nn">FsCheckConfig</span><span class="p">.</span><span class="n">defaultConfig</span> <span class="k">with</span> <span class="n">arbitrary</span> <span class="p">=</span> <span class="p">[</span> <span class="n">typeof</span><span class="p">&lt;</span><span class="nc">IdentityNumberGenerators</span><span class="p">&gt;</span> <span class="o">]}</span> 
<span class="k">let</span> <span class="n">testProp</span> <span class="p">=</span> <span class="n">testPropertyWithConfig</span> <span class="n">config</span>

<span class="n">testProp</span> <span class="s2">"roundtrip for 12 digit string"</span> <span class="p">&lt;|</span> <span class="k">fun</span> <span class="n">pin</span> <span class="p">-&gt;</span>
    <span class="n">pin</span>
    <span class="p">|&gt;</span> <span class="nn">SwedishPersonalIdentityNumber</span><span class="p">.</span><span class="n">to12DigitString</span>
    <span class="p">|&gt;</span> <span class="nn">SwedishPersonalIdentityNumber</span><span class="p">.</span><span class="n">parse</span> <span class="o">=!</span> <span class="nc">Ok</span> <span class="n">pin</span>
</code></pre></div></div>

<p>And if we run that test it still passes.</p>

<p>So what we have now is a passing property test that shows us that we can parse a valid 12 digit string, and that the to12DigitString function is working as expected. This one test actually has the same coverage as about 25 of our original example based tests.</p>

<h2 id="adding-type-safety-to-our-generators">Adding type safety to our generators</h2>

<p>The setup for the test above is fine as long as we only have one generator for <code class="highlighter-rouge">SwedishPersonalIdentityNumber</code>. If we where to have more than one generator for the same type and add both to the configuration. For example, let’s say we write two new generators to generate valid and invalid years. Both will have the type <code class="highlighter-rouge">Arbitrary&lt;int&gt;</code> and if we were to add them to the configuration:</p>
<div class="language-fsharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">let</span> <span class="n">config</span> <span class="p">=</span> <span class="p">{</span> <span class="nn">FsCheckConfig</span><span class="p">.</span><span class="n">defaultConfig</span> <span class="k">with</span> <span class="n">arbitrary</span> <span class="p">=</span> 
    <span class="p">[</span> <span class="n">typeof</span><span class="p">&lt;</span><span class="nc">ValidYearGenerator</span><span class="o">&gt;;</span> <span class="n">typeof</span><span class="p">&lt;</span><span class="nc">InvalidYearGenerator</span><span class="p">&gt;</span> <span class="p">]</span> <span class="p">}</span>
</code></pre></div></div>

<p>then the only the second one would be used, i.e. if we wrote a property test that takes an <code class="highlighter-rouge">int</code> as an input, then all of them would be generated using the <code class="highlighter-rouge">InvalidYearGenerator</code>.</p>

<p>A common approach to deal with this problem is to wrap your generators in single-case discriminated unions. Instead of writing a generator for a valid pin to be of type <code class="highlighter-rouge">Gen&lt;SwedishPersonalIdentityNumber&gt;</code> we create a new single-case DU: <code class="highlighter-rouge">type ValidPin = ValidPin of SwedishPersonalIdentityNumber</code>. Then we rewrite our generator to be of type <code class="highlighter-rouge">Gen&lt;ValidPin&gt;</code>:</p>

<div class="language-fsharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">type</span> <span class="nc">ValidPin</span> <span class="p">=</span> <span class="nc">ValidPin</span> <span class="k">of</span> <span class="nc">SwedishPersonalIdentityNumber</span>
<span class="c1">// Arbitrary&lt;ValidPin&gt;</span>
<span class="k">let</span> <span class="n">validPinGen</span><span class="bp">()</span> <span class="p">=</span>
    <span class="n">gen</span> <span class="p">{</span> <span class="k">return</span> <span class="nn">SwedishPersonalIdentityNumberTestData</span><span class="p">.</span><span class="n">getRandom</span><span class="bp">()</span> <span class="p">|&gt;</span> <span class="nc">ValidPin</span> <span class="p">}</span>
    <span class="p">|&gt;</span> <span class="nn">Arb</span><span class="p">.</span><span class="n">fromGen</span>
</code></pre></div></div>

<p>And update the test where we use it:</p>
<div class="language-fsharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">testProp</span> <span class="s2">"roundtrip for 12 digit string"</span> <span class="p">&lt;|</span> <span class="k">fun</span> <span class="p">(</span><span class="nc">ValidPin</span> <span class="n">pin</span><span class="p">)</span> <span class="p">-&gt;</span>
    <span class="n">pin</span>
    <span class="p">|&gt;</span> <span class="nn">SwedishPersonalIdentityNumber</span><span class="p">.</span><span class="n">to12DigitString</span>
    <span class="p">|&gt;</span> <span class="nn">SwedishPersonalIdentityNumber</span><span class="p">.</span><span class="n">parse</span> <span class="o">=!</span> <span class="nc">Ok</span> <span class="n">pin</span>
</code></pre></div></div>

<p>So in our test function we are deconstructing the <code class="highlighter-rouge">ValidPin</code> discriminated union directly in the function definition: <code class="highlighter-rouge">(ValidPin pin)</code>. Now when we add more generators it will be much clearer which one we are actually using in which test:</p>

<div class="language-fsharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">fun</span> <span class="n">pin</span> <span class="p">-&gt;</span> <span class="o">...</span>
</code></pre></div></div>
<p>versus</p>
<div class="language-fsharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">fun</span> <span class="p">(</span><span class="nc">ValidPin</span> <span class="n">pin</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="o">...</span>
</code></pre></div></div>

<h2 id="valid-10-digit-strings">Valid 10 digit strings</h2>

<p>To complete our happy path we must deal with 10 digit strings as well. An additional business rule here is that 10 digit strings can contain a delimiter (either “-“ or “+” where a missing delimiter is interpreted as “-“).</p>

<div class="language-fsharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">testProp</span> <span class="s2">"roundtrip for 10 digit string with delimiter"</span> <span class="p">&lt;|</span> <span class="k">fun</span> <span class="p">(</span><span class="nc">ValidPin</span> <span class="n">pin</span><span class="p">)</span> <span class="p">-&gt;</span>
    <span class="n">pin</span>
    <span class="p">|&gt;</span> <span class="nn">SwedishPersonalIdentityNumber</span><span class="p">.</span><span class="n">to10DigitString</span>
    <span class="p">|&gt;</span> <span class="nn">Result</span><span class="p">.</span><span class="n">bind</span> <span class="nn">SwedishPersonalIdentityNumber</span><span class="p">.</span><span class="n">parse</span> <span class="o">=!</span> <span class="nc">Ok</span> <span class="n">pin</span>

<span class="n">testProp</span> <span class="s2">"roundtrip for 10 digit string without hyphen-delimiter"</span> <span class="p">&lt;|</span> <span class="k">fun</span> <span class="p">(</span><span class="nc">ValidPin</span> <span class="n">pin</span><span class="p">)</span> <span class="p">-&gt;</span>
    <span class="k">let</span> <span class="n">removeHyphen</span> <span class="p">(</span><span class="n">str</span><span class="p">:</span><span class="kt">string</span><span class="p">)</span> <span class="p">=</span>
        <span class="k">let</span> <span class="n">isHyphen</span> <span class="p">(</span><span class="n">c</span><span class="p">:</span><span class="kt">char</span><span class="p">)</span> <span class="p">=</span> <span class="s2">"-"</span><span class="p">.</span><span class="nc">Contains</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
        <span class="nn">String</span><span class="p">.</span><span class="n">filter</span> <span class="p">(</span><span class="n">isHyphen</span> <span class="o">&gt;&gt;</span> <span class="k">not</span><span class="p">)</span> <span class="n">str</span>

    <span class="n">pin</span>
    <span class="p">|&gt;</span> <span class="nn">SwedishPersonalIdentityNumber</span><span class="p">.</span><span class="n">to10DigitString</span>
    <span class="p">|&gt;</span> <span class="nn">Result</span><span class="p">.</span><span class="n">map</span> <span class="n">removeHyphen</span>
    <span class="p">|&gt;</span> <span class="nn">Result</span><span class="p">.</span><span class="n">bind</span> <span class="nn">SwedishPersonalIdentityNumber</span><span class="p">.</span><span class="n">parse</span> <span class="o">=!</span> <span class="nc">Ok</span> <span class="n">pin</span>
</code></pre></div></div>

<p>As you can see we now have to use <code class="highlighter-rouge">Result.bind</code> and Result.<code class="highlighter-rouge">map</code> since <code class="highlighter-rouge">.to10DigitString</code> returns a Result&lt;string,Error&gt;. <code class="highlighter-rouge">to10DigitString</code> is an operation that actually can fail.</p>

<h2 id="other-valid-pin-strings">Other valid pin strings</h2>

<h3 id="12-digit-strings-with-extra-noise">12 digit strings with extra “noise”</h3>
<p>There are some other tests in the original test suite for inputs that actually are valid. For example the parse function should be able to handle leading and trailing whitespaces. Actually if you really dive down into the requirements you will find that for 12 digit strings we should be able to parse an input as long as it contains 12 valid digits. I.e. even if there are any leading, trailing, or interspersed characters between the digits. For example if <em>“192011149255”</em> is a valid pin, then <em>”   192011149255   “</em> with leading and trailing whitespace is also valid. And taken to its extreme: <em>” a1b9c2d0e1f1g1h4i9j2k5l5m “</em> is a valid pin<sup id="fnref:3"><a href="#fn:3" class="footnote">3</a></sup>. But how can we test this?</p>

<p>We need to generate the valid input but with some noise. One way to do this is to generate a random string and then remove any digits it contains in our test. FsCheck can generate a string for us out of the box, but it will generate strings of any length and with nulls. To avoid any problems with too short strings we will write a generator that generates a string with length 100. Since we will be filtering the array for digits it is easier to keep it as a <code class="highlighter-rouge">char[]</code> for now:</p>

<div class="language-fsharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">type</span> <span class="nc">Char100</span> <span class="p">=</span> <span class="nc">Char100</span> <span class="k">of</span> <span class="kt">char</span><span class="bp">[]</span>

<span class="k">let</span> <span class="n">char100</span><span class="bp">()</span> <span class="p">=</span>
    <span class="nn">Gen</span><span class="p">.</span><span class="n">arrayOfLength</span> <span class="mi">100</span> <span class="nn">Arb</span><span class="p">.</span><span class="n">generate</span><span class="p">&lt;</span><span class="kt">char</span><span class="p">&gt;</span>
    <span class="p">|&gt;</span> <span class="nn">Gen</span><span class="p">.</span><span class="n">map</span> <span class="nc">Char100</span>
    <span class="p">|&gt;</span> <span class="nn">Arb</span><span class="p">.</span><span class="n">fromGen</span>
</code></pre></div></div>

<p>That is, we are using the built-in functions <code class="highlighter-rouge">arrayOfLength</code> and <code class="highlighter-rouge">generate&lt;'T&gt;</code> to generate a char[] with length 100. We then use <code class="highlighter-rouge">Gen.map</code> to turn the char[] into our <code class="highlighter-rouge">Char100</code> type.</p>

<p>We then use it in our property test like this:</p>

<div class="language-fsharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">testProp</span> <span class="s2">"roundtrip for 12 digit string mixed with 'non-digit' noise"</span> 
    <span class="p">&lt;|</span> <span class="k">fun</span> <span class="p">(</span><span class="nc">ValidPin</span> <span class="n">pin</span><span class="p">,</span> <span class="nc">Char100</span> <span class="n">charArray</span><span class="p">)</span> <span class="p">-&gt;</span>
        <span class="k">let</span> <span class="n">charsWithoutDigits</span> <span class="p">=</span>
            <span class="n">charArray</span>
            <span class="p">|&gt;</span> <span class="nn">Array</span><span class="p">.</span><span class="n">filter</span> <span class="p">(</span><span class="n">isDigit</span> <span class="o">&gt;&gt;</span> <span class="k">not</span><span class="p">)</span>

        <span class="n">pin</span>
        <span class="p">|&gt;</span> <span class="nn">SwedishPersonalIdentityNumber</span><span class="p">.</span><span class="n">to12DigitString</span>
        <span class="p">|&gt;</span> <span class="n">surroundEachChar</span> <span class="n">charsWithoutDigits</span>
        <span class="p">|&gt;</span> <span class="nn">SwedishPersonalIdentityNumber</span><span class="p">.</span><span class="n">parse</span> <span class="o">=!</span> <span class="nc">Ok</span> <span class="n">pin</span>
</code></pre></div></div>

<p><code class="highlighter-rouge">isDigit</code> and <code class="highlighter-rouge">surroundEachChar</code> are helper functions for filtering and surrounding every character in our pin string with characters from <code class="highlighter-rouge">charsWithoutDigits</code>:</p>

<div class="language-fsharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">let</span> <span class="k">private</span> <span class="n">isDigit</span> <span class="p">(</span><span class="n">c</span><span class="p">:</span><span class="kt">char</span><span class="p">)</span> <span class="p">=</span> <span class="s2">"0123456789"</span><span class="p">.</span><span class="nc">Contains</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>

<span class="k">let</span> <span class="k">private</span> <span class="n">surroundEachChar</span> <span class="p">(</span><span class="n">chars</span><span class="p">:</span><span class="kt">char</span><span class="bp">[]</span><span class="p">)</span> <span class="p">(</span><span class="n">pin</span><span class="p">:</span><span class="kt">string</span><span class="p">)</span> <span class="p">=</span>
    <span class="k">let</span> <span class="n">getRandomChar</span> <span class="p">=</span> <span class="n">getRandomFromArray</span> <span class="n">chars</span>
    <span class="k">let</span> <span class="n">surroundWith</span> <span class="n">c</span> <span class="p">=</span> <span class="p">[|</span> <span class="n">getRandomChar</span><span class="bp">()</span><span class="p">;</span> <span class="n">c</span><span class="p">;</span> <span class="n">getRandomChar</span><span class="bp">()</span> <span class="p">|]</span>

    <span class="nn">Seq</span><span class="p">.</span><span class="n">collect</span> <span class="n">surroundWith</span> <span class="n">pin</span>
    <span class="p">|&gt;</span> <span class="nn">Array</span><span class="p">.</span><span class="n">ofSeq</span>
    <span class="p">|&gt;</span> <span class="nn">System</span><span class="p">.</span><span class="nc">String</span>
</code></pre></div></div>

<h3 id="conclusion">Conclusion</h3>

<p>That’s almost all the tests we need for parsing valid strings. We do need tests for 10 digit strings with some random noise added, but those tests will be very similar to the tests for 12 digit strings. So I will leave those tests as an exercise to the reader.<sup id="fnref:4"><a href="#fn:4" class="footnote">4</a></sup></p>

<p>As we can see we ended up with only 4 test cases, but we are really verifying a lot with those tests. We know the <code class="highlighter-rouge">parse</code> function and to10/12digitString functions are working for valid inputs. Comparing this with C# unit test suite we have replaced about 30 unit tests. Additionally, since our property based tests are using randomly generated inputs, we are actually testing many, many more inputs than we did in the C# unit test suite.</p>

<p>I feel we have covered enough ground in this blog post so I will stop here. In the next post we will look at the tests for invalid inputs.</p>

<div class="footnotes">
  <ol>
    <li id="fn:1">
      <p>So given a 12 digit pin: 191012249833 the 10 digit representation would be 101224-9833 up to year 2009, from year 2010 an onwards the 10 digit representation would be 101224+9833. <a href="#fnref:1" class="reversefootnote">&#8617;</a></p>
    </li>
    <li id="fn:2">
      <p>Actually the exception message is a bit cryptic, but it is due to the private constructor on our Year-type which is the first type it tries to create for our SwedishPersonalIdentityNumber. <a href="#fnref:2" class="reversefootnote">&#8617;</a></p>
    </li>
    <li id="fn:3">
      <p>It may seem overzealous to test for pins with this kind of noise. But it actually comes from some specific test cases that we had to deal with in our code base, mostly dealing with issues with how users are writing the delimiter in the pin. This is just the generalization of all those types of examples. <a href="#fnref:3" class="reversefootnote">&#8617;</a></p>
    </li>
    <li id="fn:4">
      <p>Also the real test suite has some tests for a <code class="highlighter-rouge">parseInSpecificYear</code> function which is needed due to the nature of the 10 digit format. But it only adds complexity that is not really related to property based testing so I will also leave these tests out of this blog post. <a href="#fnref:4" class="reversefootnote">&#8617;</a></p>
    </li>
  </ol>
</div>

        
      </section>

      <footer class="page__meta">
        
        
  


  
  
  

  <p class="page__taxonomy">
    <strong><i class="fas fa-fw fa-tags" aria-hidden="true"></i> Tags: </strong>
    <span itemprop="keywords">
    
      
      
      <a href="/tags/#fsharp" class="page__taxonomy-item" rel="tag">fsharp</a><span class="sep">, </span>
    
      
      
      <a href="/tags/#tests" class="page__taxonomy-item" rel="tag">tests</a>
    
    </span>
  </p>




  


  
  
  

  <p class="page__taxonomy">
    <strong><i class="fas fa-fw fa-folder-open" aria-hidden="true"></i> Categories: </strong>
    <span itemprop="keywords">
    
      
      
      <a href="/categories/#fsharp" class="page__taxonomy-item" rel="tag">fsharp</a>
    
    </span>
  </p>


        
          <p class="page__date"><strong><i class="fas fa-fw fa-calendar-alt" aria-hidden="true"></i> Updated:</strong> <time datetime="2019-08-12T07:45:00+02:00">August 12, 2019</time></p>
        
      </footer>

      <section class="page__share">
  

  <a href="https://twitter.com/intent/tweet?via=Emmet_Ray&text=Migrating+a+C%23+test+suite+to+property+based+tests+in+F%23+-+part+1%20https%3A%2F%2Fviktorvan.github.io%2Ffsharp%2Fmigrating-activelogin.identity-to-property-based-tests-1%2F" class="btn btn--twitter" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on Twitter"><i class="fab fa-fw fa-twitter" aria-hidden="true"></i><span> Twitter</span></a>

  <a href="https://www.facebook.com/sharer/sharer.php?u=https%3A%2F%2Fviktorvan.github.io%2Ffsharp%2Fmigrating-activelogin.identity-to-property-based-tests-1%2F" class="btn btn--facebook" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on Facebook"><i class="fab fa-fw fa-facebook" aria-hidden="true"></i><span> Facebook</span></a>

  <a href="https://www.linkedin.com/shareArticle?mini=true&url=https%3A%2F%2Fviktorvan.github.io%2Ffsharp%2Fmigrating-activelogin.identity-to-property-based-tests-1%2F" class="btn btn--linkedin" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on LinkedIn"><i class="fab fa-fw fa-linkedin" aria-hidden="true"></i><span> LinkedIn</span></a>
</section>


      
  <nav class="pagination">
    
      <a href="/fsharp/domain-modeling-with-fsharp/" class="pagination--pager" title="Why you should model your domain with F#
">Previous</a>
    
    
      <a href="/fsharp/migrating-activelogin.identity-to-property-based-tests-2/" class="pagination--pager" title="Migrating a C# test suite to property based tests in F# - part 2
">Next</a>
    
  </nav>

    </div>

    
  </article>

  
  
    <div class="page__related">
      <h4 class="page__related-title">You May Also Enjoy</h4>
      <div class="grid__wrapper">
        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title" itemprop="headline">
      
        <a href="/fsharp/migrating-activelogin.identity-to-property-based-tests-2/" rel="permalink">Migrating a C# test suite to property based tests in F# - part 2
</a>
      
    </h2>
    
      <p class="page__meta"><i class="far fa-clock" aria-hidden="true"></i> 




  8 minute read
</p>
    
    <p class="archive__item-excerpt" itemprop="description">Background

</p>
  </article>
</div>

        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title" itemprop="headline">
      
        <a href="/fsharp/domain-modeling-with-fsharp/" rel="permalink">Why you should model your domain with F#
</a>
      
    </h2>
    
      <p class="page__meta"><i class="far fa-clock" aria-hidden="true"></i> 




  12 minute read
</p>
    
    <p class="archive__item-excerpt" itemprop="description">Recently when working on a feature for a client, writing the normal barrage of C# null-checks and unit-tests verifying that my model state wasn’t invalid, a ...</p>
  </article>
</div>

        
      </div>
    </div>
  
  
</div>

    </div>

    

    <div id="footer" class="page__footer">
      <footer>
        <!-- start custom footer snippets -->

<!-- end custom footer snippets -->
        <div class="page__footer-follow">
  <ul class="social-icons">
    

    
      
        
          <li><a href="https://twitter.com/Emmet_Ray" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-twitter-square" aria-hidden="true"></i> Twitter</a></li>
        
      
        
      
        
      
        
      
        
      
        
      
    

    <li><a href="/feed.xml"><i class="fas fa-fw fa-rss-square" aria-hidden="true"></i> Feed</a></li>
  </ul>
</div>

<div class="page__footer-copyright">&copy; 2019 Viktor Andersson. Powered by <a href="https://jekyllrb.com" rel="nofollow">Jekyll</a> &amp; <a href="https://mademistakes.com/work/minimal-mistakes-jekyll-theme/" rel="nofollow">Minimal Mistakes</a>.</div>

      </footer>
    </div>

    
  <script src="/assets/js/main.min.js"></script>
  <script src="https://kit.fontawesome.com/4eee35f757.js"></script>










  </body>
</html>
