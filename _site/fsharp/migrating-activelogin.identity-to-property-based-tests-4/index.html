<!doctype html>
<!--
  Minimal Mistakes Jekyll Theme 4.16.6 by Michael Rose
  Copyright 2013-2019 Michael Rose - mademistakes.com | @mmistakes
  Free for personal and commercial use under the MIT license
  https://github.com/mmistakes/minimal-mistakes/blob/master/LICENSE
-->
<html lang="en" class="no-js">
  <head>
    <meta charset="utf-8">

<!-- begin _includes/seo.html --><title>Migrating a C# test suite to property based tests in F# - part 4 - Viktor Andersson</title>
<meta name="description" content="Property based tests part 4 - production code repeated in tests.">


  <meta name="author" content="Viktor Andersson">


<meta property="og:type" content="article">
<meta property="og:locale" content="en_US">
<meta property="og:site_name" content="Viktor Andersson">
<meta property="og:title" content="Migrating a C# test suite to property based tests in F# - part 4">
<meta property="og:url" content="https://viktorvan.github.io/fsharp/migrating-activelogin.identity-to-property-based-tests-4/">


  <meta property="og:description" content="Property based tests part 4 - production code repeated in tests.">



  <meta property="og:image" content="https://viktorvan.github.io/assets/images/sansebastian2.jpg">



  <meta name="twitter:site" content="@Emmet_Ray">
  <meta name="twitter:title" content="Migrating a C# test suite to property based tests in F# - part 4">
  <meta name="twitter:description" content="Property based tests part 4 - production code repeated in tests.">
  <meta name="twitter:url" content="https://viktorvan.github.io/fsharp/migrating-activelogin.identity-to-property-based-tests-4/">

  
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:image" content="https://viktorvan.github.io/assets/images/sansebastian2.jpg">
  

  



  <meta property="article:published_time" content="2019-09-05T17:00:00+02:00">





  

  


<link rel="canonical" href="https://viktorvan.github.io/fsharp/migrating-activelogin.identity-to-property-based-tests-4/">




<script type="application/ld+json">
  {
    "@context": "https://schema.org",
    
      "@type": "Person",
      "name": "Viktor Andersson",
      "url": "https://viktorvan.github.io/"
    
  }
</script>






<!-- end _includes/seo.html -->


<link href="/feed.xml" type="application/atom+xml" rel="alternate" title="Viktor Andersson Feed">

<!-- https://t.co/dKP3o1e -->
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script>
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
</script>

<!-- For all browsers -->
<link rel="stylesheet" href="/assets/css/main.css">

<!--[if IE ]>
  <style>
    /* old IE unsupported flexbox fixes */
    .greedy-nav .site-title {
      padding-right: 3em;
    }
    .greedy-nav button {
      position: absolute;
      top: 0;
      right: 0;
      height: 100%;
    }
  </style>
<![endif]-->



    <!-- start custom head snippets -->

<!-- insert favicons. use https://realfavicongenerator.net/ -->

<!-- end custom head snippets -->

  </head>

  <body class="layout--single wide">
    <nav class="skip-links">
  <h2 class="screen-reader-text">Skip links</h2>
  <ul>
    <li><a href="#site-nav" class="screen-reader-shortcut">Skip to primary navigation</a></li>
    <li><a href="#main" class="screen-reader-shortcut">Skip to content</a></li>
    <li><a href="#footer" class="screen-reader-shortcut">Skip to footer</a></li>
  </ul>
</nav>

    <!--[if lt IE 9]>
<div class="notice--danger align-center" style="margin: 0;">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience.</div>
<![endif]-->

    

<div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="greedy-nav">
        
        <a class="site-title" href="/">
          Viktor Andersson
          
        </a>
        <ul class="visible-links"><li class="masthead__menu-item">
              <a href="/tags/" >Tags</a>
            </li></ul>
        
        <button class="greedy-nav__toggle hidden" type="button">
          <span class="visually-hidden">Toggle menu</span>
          <div class="navicon"></div>
        </button>
        <ul class="hidden-links hidden"></ul>
      </nav>
    </div>
  </div>
</div>


    <div class="initial-content">
      
  











<div class="page__hero--overlay"
  style=" background-image: linear-gradient(rgba(0, 0, 0, 0.4), rgba(0, 0, 0, 0.4)), url('/assets/images/sansebastian2.jpg');"
>
  
    <div class="wrapper">
      <h1 id="page-title" class="page__title" itemprop="headline">
        
          Migrating a C# test suite to property based tests in F# - part 4

        
      </h1>
      
        <p class="page__lead">Property based tests part 4 - production code repeated in tests.

</p>
      
      
        <p class="page__meta"><i class="far fa-clock" aria-hidden="true"></i> 




  11 minute read
</p>
      
      
      
    </div>
  
  
</div>





<div id="main" role="main">
  
  <div class="sidebar sticky">
  


<div itemscope itemtype="https://schema.org/Person">

  
    <div class="author__avatar">
      

      
        <img src="/assets/images/bio-photo.jpg" alt="Viktor Andersson" itemprop="image">
      
    </div>
  

  <div class="author__content">
    
      <h3 class="author__name" itemprop="name">Viktor Andersson</h3>
    
    
      <div class="author__bio" itemprop="description">
        <p>Software developer, beekeeper and F# enthusiast</p>

      </div>
    
  </div>

  <div class="author__urls-wrapper">
    <button class="btn btn--inverse">Follow</button>
    <ul class="author__urls social-icons">
      
        <li itemprop="homeLocation" itemscope itemtype="https://schema.org/Place">
          <i class="fas fa-fw fa-map-marker-alt" aria-hidden="true"></i> <span itemprop="name">Stockholm, Sweden</span>
        </li>
      

      
        
          
            <li><a href="mailto:v.andersson@me.com" rel="nofollow noopener noreferrer"><i class="fas fa-fw fa-envelope-square" aria-hidden="true"></i> Email</a></li>
          
        
          
        
          
            <li><a href="https://twitter.com/Emmet_Ray" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-twitter-square" aria-hidden="true"></i> Twitter</a></li>
          
        
          
        
          
            <li><a href="https://github.com/viktorvan" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-github" aria-hidden="true"></i> GitHub</a></li>
          
        
          
        
          
            <li><a href="https://www.linkedin.com/in/viktorand/" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-linkedin" aria-hidden="true"></i> LinkedIn</a></li>
          
        
      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      <!--
  <li>
    <a href="http://link-to-whatever-social-network.com/user/" itemprop="sameAs" rel="nofollow noopener noreferrer">
      <i class="fas fa-fw" aria-hidden="true"></i> Custom Social Profile Link
    </a>
  </li>
-->
    </ul>
  </div>
</div>

  
  </div>


  <article class="page" itemscope itemtype="https://schema.org/CreativeWork">
    <meta itemprop="headline" content="Migrating a C# test suite to property based tests in F# - part 4">
    <meta itemprop="description" content="Property based tests part 4 - production code repeated in tests.">
    <meta itemprop="datePublished" content="September 05, 2019">
    

    <div class="page__inner-wrap">
      

      <section class="page__content" itemprop="text">
        
          <aside class="sidebar__right ">
            <nav class="toc">
              <header><h4 class="nav__title"><i class="fas fa-file-alt"></i> On this page</h4></header>
              <ul class="toc__menu">
  <li><a href="#background">Background</a></li>
  <li><a href="#hard-to-test-properties">‚ÄúHard to test properties‚Äù</a>
    <ul>
      <li><a href="#getting-a-persons-age-from-a-pin">Getting a persons age from a pin</a></li>
    </ul>
  </li>
  <li><a href="#duplicating-production-code-in-a-test">Duplicating production code in a test</a>
    <ul>
      <li><a href="#working-with-legacy-code">Working with legacy code</a></li>
      <li><a href="#performance">Performance</a></li>
    </ul>
  </li>
  <li><a href="#conclusions">Conclusions</a></li>
</ul>
            </nav>
          </aside>
        
        <p>Property based tests part 4 - production code repeated in tests.</p>

<h1 id="background">Background</h1>

<p>This is part 4 in a four part series:</p>

<p><a href="https://viktorvan.github.io/fsharp/migrating-activelogin.identity-to-property-based-tests-1/">Part 1 - Introduction to property based testing</a></p>

<p><a href="https://viktorvan.github.io/fsharp/migrating-activelogin.identity-to-property-based-tests-2/">Part 2 - More about generators</a></p>

<p><a href="https://viktorvan.github.io/fsharp/migrating-activelogin.identity-to-property-based-tests-3/">Part 3 - Generators with too many output values</a></p>

<p>I‚Äôve been wanting to try property-based testing in a real-life situation for some time, and decided to try it out with the test suite for our open source library ActiveLogin.Identity.</p>

<p>A short background on ActiveLogin.Identity; it‚Äôs a library for parsing and validating Swedish identities, such as a Personal Identity Number, let‚Äôs call it a <strong>pin</strong>. For this blog we can be satisfied with the following simplified model: the format for a pin is YYYYMMDDBBBC, i.e. <strong>Y</strong>ear, <strong>M</strong>onth, <strong>D</strong>ay, <strong>B</strong>irth number and a checksum. The birth number is any number three digit number from 001 to 999, the checksum is calculated using the <a href="https://en.wikipedia.org/wiki/Luhn_algorithm">Luhn algorithm</a>. You can also write a pin using a 10 digit format YYMMDD-BBBC or YYMMDD+BBBC, where a ‚Äú+‚Äù indicates that the person has turned or is turning 100 this year.</p>

<p>In the previous posts we have written property tests for valid and invalid pin numbers. We have had to deal with ranges of inputs that are very large. In this final post we will deal with tests where we feel the need to repeat the production code in the tests. We will discuss when this is ok or not.</p>

<h1 id="hard-to-test-properties">‚ÄúHard to test properties‚Äù</h1>

<p>The final group of tests I will discuss in this series of blog posts is tests where we would like to repeat the logic from the production code in the test just to figure out what the expected result should be. For example, since the first 8 digits (or 6 in the 10-digit version) of the swedish personal identity number corresponds to your date of birth (most of the time<sup id="fnref:1"><a href="#fn:1" class="footnote">1</a></sup>) the Active.Identity library provides a helper function to get a person‚Äôs age given an identity number. Let‚Äôs write a test for that function.</p>

<h2 id="getting-a-persons-age-from-a-pin">Getting a persons age from a pin</h2>

<p>Getting a persons date of birth is just a matter of looking at the Year, Month and Day properties of the pin. Calculating the age is a bit more complicated, mostly due to leap years. This is the implementation in the library:</p>

<div class="language-fsharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">let</span> <span class="n">getAgeHintOnDate</span> <span class="n">date</span> <span class="n">pin</span> <span class="p">=</span>
    <span class="k">let</span> <span class="n">dateOfBirth</span> <span class="p">=</span> <span class="n">getDateOfBirth</span> <span class="n">pin</span>
    <span class="k">if</span> <span class="n">date</span> <span class="o">&gt;=</span> <span class="n">dateOfBirth</span> <span class="k">then</span>
        <span class="k">let</span> <span class="n">months</span> <span class="p">=</span> <span class="mi">12</span> <span class="p">*</span> <span class="p">(</span><span class="n">date</span><span class="p">.</span><span class="nc">Year</span> <span class="p">-</span> <span class="n">dateOfBirth</span><span class="p">.</span><span class="nc">Year</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">date</span><span class="p">.</span><span class="nc">Month</span> <span class="p">-</span> <span class="n">dateOfBirth</span><span class="p">.</span><span class="nc">Month</span><span class="p">)</span>
        <span class="k">match</span> <span class="n">date</span><span class="p">.</span><span class="nc">Day</span> <span class="p">&lt;</span> <span class="n">dateOfBirth</span><span class="p">.</span><span class="nc">Day</span> <span class="k">with</span>
        <span class="p">|</span> <span class="bp">true</span> <span class="p">-&gt;</span>
            <span class="k">let</span> <span class="n">years</span> <span class="p">=</span> <span class="p">(</span><span class="n">months</span> <span class="p">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">12</span>
            <span class="n">years</span> <span class="p">|&gt;</span> <span class="nc">Some</span>
        <span class="p">|</span> <span class="bp">false</span> <span class="p">-&gt;</span> <span class="n">months</span> <span class="o">/</span> <span class="mi">12</span> <span class="p">|&gt;</span> <span class="nc">Some</span>
    <span class="k">else</span> <span class="nc">None</span>
</code></pre></div></div>

<p>Now, if we were going to tests this function using an example based unit test, it wouldn‚Äôt be so hard. We would just take some examples where we know what the expected age should be and test with that; from the C# test suite<sup id="fnref:2"><a href="#fn:2" class="footnote">2</a></sup>:</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">[Theory]</span>
<span class="c1">// Birth non leap year, before "leap day"</span>
<span class="na">[InlineData("201701052399", "20180104", 0)]</span>
<span class="na">[InlineData("201701052399", "20180105", 1)]</span>
<span class="na">[InlineData("201701052399", "20190104", 1)]</span>
<span class="na">[InlineData("201701052399", "20190105", 2)]</span>
<span class="na">[InlineData("201701052399", "20200104", 2)]</span>
<span class="na">[InlineData("201701052399", "20200105", 3)]</span>

<span class="c1">// Birth non leap year, after "leap day"</span>
<span class="na">[InlineData("201703052397", "20180304", 0)]</span>
<span class="na">[InlineData("201703052397", "20180305", 1)]</span>
<span class="na">[InlineData("201703052397", "20190304", 1)]</span>
<span class="na">[InlineData("201703052397", "20190305", 2)]</span>
<span class="na">[InlineData("201703052397", "20200304", 2)]</span>
<span class="na">[InlineData("201703052397", "20200305", 3)]</span>

<span class="c1">// Birth leap year, after leap day</span>
<span class="na">[InlineData("201603102383", "20170309", 0)]</span>
<span class="na">[InlineData("201603102383", "20170310", 1)]</span>
<span class="na">[InlineData("201603102383", "20180309", 1)]</span>
<span class="na">[InlineData("201603102383", "20180310", 2)]</span>
<span class="na">[InlineData("201603102383", "20190309", 2)]</span>
<span class="na">[InlineData("201603102383", "20190310", 3)]</span>
<span class="na">[InlineData("201603102383", "20200309", 3)]</span>
<span class="na">[InlineData("201603102383", "20200310", 4)]</span>

<span class="c1">// Birth leap year, on leap day</span>
<span class="na">[InlineData("201602292383", "20160229", 0)]</span>
<span class="na">[InlineData("201602292383", "20170228", 0)]</span>
<span class="na">[InlineData("201602292383", "20170301", 1)]</span>
<span class="na">[InlineData("201602292383", "20200228", 3)]</span>
<span class="na">[InlineData("201602292383", "20200229", 4)]</span>
<span class="k">public</span> <span class="k">void</span> <span class="nf">GetAgeHint_Handles_LeapYears_Correctly</span><span class="p">(</span><span class="kt">string</span> <span class="n">personalIdentityNumber</span><span class="p">,</span> <span class="kt">string</span> <span class="n">actualDate</span><span class="p">,</span> <span class="kt">int</span> <span class="n">expectedAge</span><span class="p">)</span>
<span class="p">{</span>
    <span class="c1">// Arrange</span>
    <span class="kt">var</span> <span class="n">swedishPersonalIdentityNumber</span> <span class="p">=</span> <span class="n">SwedishPersonalIdentityNumber</span><span class="p">.</span><span class="nf">Parse</span><span class="p">(</span><span class="n">personalIdentityNumber</span><span class="p">);</span>
    <span class="kt">var</span> <span class="n">date</span> <span class="p">=</span> <span class="n">DateTime</span><span class="p">.</span><span class="nf">ParseExact</span><span class="p">(</span><span class="n">actualDate</span><span class="p">,</span> <span class="s">"yyyyMMdd"</span><span class="p">,</span> <span class="n">CultureInfo</span><span class="p">.</span><span class="n">InvariantCulture</span><span class="p">,</span> <span class="n">DateTimeStyles</span><span class="p">.</span><span class="n">AssumeLocal</span><span class="p">);</span>

    <span class="c1">// Act</span>
    <span class="kt">var</span> <span class="n">age</span> <span class="p">=</span> <span class="n">swedishPersonalIdentityNumber</span><span class="p">.</span><span class="nf">GetAgeHint</span><span class="p">(</span><span class="n">date</span><span class="p">);</span>

    <span class="c1">// Assert</span>
    <span class="n">Assert</span><span class="p">.</span><span class="nf">Equal</span><span class="p">(</span><span class="n">expectedAge</span><span class="p">,</span> <span class="n">age</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>if we tried to write a property based test in the same way we would end up with something like this:</p>

<div class="language-fsharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">testProp</span> <span class="s2">"getAgeHintOnDate calculates the age from a pin"</span> 
    <span class="p">&lt;|</span> <span class="k">fun</span> <span class="p">(</span><span class="nn">Gen</span><span class="p">.</span><span class="nc">ValidPin</span> <span class="n">pin</span><span class="p">,</span> <span class="nc">DateTime</span> <span class="n">date</span><span class="p">)</span> <span class="p">-&gt;</span>
        <span class="k">let</span> <span class="n">expectedAge</span> <span class="p">=</span> <span class="n">calculateExpectedAge</span> <span class="n">date</span> <span class="n">pin</span>
        <span class="nn">Hints</span><span class="p">.</span><span class="n">getAgeHintOnDate</span> <span class="n">date</span> <span class="n">pin</span> <span class="o">=!</span> <span class="n">expectedAge</span>
</code></pre></div></div>

<p>But what would calculateExpectedAge look like? It‚Äôs exactly the same thing as the code we want to test. We can‚Äôt just copy the production code, then we aren‚Äôt really testing anything. It‚Äôs almost like stating the property ‚Äúa person <strong>x</strong> years old is <strong>x</strong> years old‚Äù.</p>

<p>In some cases maybe we can think of an alternative implementation and use in the test instead, but in many cases that will not be feasible. Otherwise we need to think of another property to test to fulfill our requirements.</p>

<p>In this case another property for the age calculation could be expressed as ‚Äúa person ages by years counting from their date of birth‚Äù. Maybe it‚Äôs not clear straight away why that is a better property to test. Let‚Äôs write the test and see. Actually since the logic for people born on leap days makes it complicated we‚Äôll actually split this into two separate tests.</p>

<p>First we will deal with people not born on a leap day and for this test we need a generator for Age, like this:</p>

<div class="language-fsharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">type</span> <span class="nc">Age</span> <span class="p">=</span> <span class="nc">Age</span> <span class="k">of</span> <span class="nc">Years</span> <span class="p">:</span> <span class="kt">int</span> <span class="p">*</span> <span class="nc">Months</span> <span class="p">:</span> <span class="kt">int</span> <span class="p">*</span> <span class="nc">Days</span> <span class="p">:</span> <span class="n">double</span>

<span class="k">let</span> <span class="n">age</span><span class="bp">()</span> <span class="p">=</span>
    <span class="n">gen</span> <span class="p">{</span>
        <span class="k">let</span><span class="o">!</span> <span class="n">years</span> <span class="p">=</span> <span class="nn">Gen</span><span class="p">.</span><span class="n">choose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">199</span><span class="p">)</span>
        <span class="k">let</span><span class="o">!</span> <span class="n">months</span> <span class="p">=</span> <span class="nn">Gen</span><span class="p">.</span><span class="n">choose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">11</span><span class="p">)</span>
        <span class="k">let</span><span class="o">!</span> <span class="n">days</span> <span class="p">=</span> <span class="nn">Gen</span><span class="p">.</span><span class="n">choose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">27</span><span class="p">)</span> <span class="p">|&gt;</span> <span class="nn">Gen</span><span class="p">.</span><span class="n">map</span> <span class="kt">float</span>

        <span class="k">return</span> <span class="nc">Age</span> <span class="p">(</span><span class="nc">Years</span> <span class="p">=</span> <span class="n">years</span><span class="p">,</span> <span class="nc">Months</span> <span class="p">=</span> <span class="n">months</span><span class="p">,</span><span class="nc">Days</span> <span class="p">=</span> <span class="n">days</span><span class="p">)</span>
    <span class="p">}</span> <span class="p">|&gt;</span> <span class="nn">Arb</span><span class="p">.</span><span class="n">fromGen</span>
</code></pre></div></div>

<p>The 10-digit format actually breaks down for ages &gt; 199<sup id="fnref:3"><a href="#fn:3" class="footnote">3</a></sup> so we will limit our generator to only yield ages in the range [0,199]. For the months we pick any number of months from 0 to 11, so the person has not aged a full year. And in the same way we don‚Äôt want the person to have aged a full month in days, so we pick any day in the range [0,27] since the shortest month has 28 days.</p>

<p>We can then write our property test.</p>

<div class="language-fsharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">testProp</span> <span class="s2">"A person ages by years counting from their date of birth"</span>
    <span class="p">&lt;|</span> <span class="k">fun</span> <span class="p">(</span><span class="nc">ValidPin</span> <span class="n">pin</span><span class="p">,</span> <span class="nc">Age</span> <span class="p">(</span><span class="n">years</span><span class="p">,</span> <span class="n">months</span><span class="p">,</span> <span class="n">days</span><span class="o">))</span> <span class="p">-&gt;</span>
        <span class="k">not</span> <span class="p">(</span><span class="n">pin</span><span class="p">.</span><span class="nn">Month</span><span class="p">.</span><span class="nc">Value</span> <span class="p">=</span> <span class="mi">2</span> <span class="p">&amp;&amp;</span> <span class="n">pin</span><span class="p">.</span><span class="nn">Day</span><span class="p">.</span><span class="nc">Value</span> <span class="p">=</span> <span class="mi">29</span><span class="p">)</span> <span class="o">==&gt;</span>
        <span class="k">lazy</span>
            <span class="k">let</span> <span class="n">dateOfBirth</span> <span class="p">=</span> <span class="nc">DateTime</span><span class="p">(</span><span class="n">pin</span><span class="p">.</span><span class="nn">Year</span><span class="p">.</span><span class="nc">Value</span><span class="p">,</span> <span class="n">pin</span><span class="p">.</span><span class="nn">Month</span><span class="p">.</span><span class="nc">Value</span><span class="p">,</span> <span class="n">pin</span><span class="p">.</span><span class="nn">Day</span><span class="p">.</span><span class="nc">Value</span><span class="p">)</span>
            <span class="k">let</span> <span class="n">checkDate</span> <span class="p">=</span>
                <span class="n">dateOfBirth</span><span class="p">.</span><span class="nn">Date</span>
                    <span class="p">.</span><span class="nc">AddYears</span><span class="p">(</span><span class="n">years</span><span class="p">)</span>
                    <span class="p">.</span><span class="nc">AddMonths</span><span class="p">(</span><span class="n">months</span><span class="p">)</span>
                    <span class="p">.</span><span class="nc">AddDays</span><span class="p">(</span><span class="n">days</span><span class="p">)</span>
            
            <span class="nn">Hints</span><span class="p">.</span><span class="n">getAgeHintOnDate</span> <span class="n">checkDate</span> <span class="n">pin</span> <span class="o">=!</span> <span class="nc">Some</span> <span class="n">years</span>
</code></pre></div></div>

<p>We have added a condition to the input value using the <code class="highlighter-rouge">==&gt;</code> operator from FsCheck that we discussed in <a href="https://viktorvan.github.io/fsharp/migrating-activelogin.identity-to-property-based-tests-2/">Part 2 - More about generators</a> to not run the test for leap days. We then extract the date of birth. We add the expected age to the date of birth and then use that as the date on which to check the age of the person. In this way we are testing the business logic calculate a person‚Äôs age, but we do not need to repeat any code from the production code.</p>

<p>Next we need to do the same thing for people born on leap days. For this test we also need a generator for leap day pins. We could try and use the same conditional approach as above, i.e.:</p>

<div class="language-fsharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">testProp</span> <span class="s2">"A person ages by years counting from their date of birth"</span>
    <span class="p">&lt;|</span> <span class="k">fun</span> <span class="p">(</span><span class="nc">ValidPin</span> <span class="n">pin</span><span class="p">,</span> <span class="nc">Age</span> <span class="p">(</span><span class="n">years</span><span class="p">,</span> <span class="n">months</span><span class="p">,</span> <span class="n">days</span><span class="o">))</span> <span class="p">-&gt;</span>
        <span class="p">(</span><span class="n">pin</span><span class="p">.</span><span class="nn">Month</span><span class="p">.</span><span class="nc">Value</span> <span class="p">=</span> <span class="mi">2</span> <span class="p">&amp;&amp;</span> <span class="n">pin</span><span class="p">.</span><span class="nn">Day</span><span class="p">.</span><span class="nc">Value</span> <span class="p">=</span> <span class="mi">29</span><span class="p">)</span> <span class="o">==&gt;</span>
        <span class="k">lazy</span>
            <span class="c1">// test implementation</span>
</code></pre></div></div>

<p>To only run the test for leap days. But there are a lot less pins for leap days than not in the test data. Most of the values FsCheck will get from the generator will cause the condition to evaluate to false, and after a certain amount of tries it will fail the test and state that it was <strong>exhausted</strong>:</p>

<div class="notice--danger">
    [18:40:34 INF] EXPECTO? Running tests... <br />
    [18:40:36 ERR] hints/getAgeHint/A person ages by years counting from their date of birth failed in 00:00:01.3020000. 
    Exhausted after 1 test <br />
    [18:40:36 INF] EXPECTO! 1 tests run in 00:00:01.3755183 for miscellaneous ‚Äì 0 passed, 0 ignored, 1 failed, 0 errored.
</div>

<p>To avoid this we can create a new generator where we take the array of pins from the test data and filter out the ones corresponding to leap days:</p>

<div class="language-fsharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">type</span> <span class="nc">LeapDayPin</span> <span class="p">=</span> <span class="nc">LeapDayPin</span> <span class="k">of</span> <span class="nc">SwedishPersonalIdentityNumber</span>

<span class="k">let</span> <span class="n">leapDayPins</span> <span class="p">=</span>
    <span class="k">let</span> <span class="n">isLeapDay</span> <span class="p">(</span><span class="n">pin</span><span class="p">:</span> <span class="nc">SwedishPersonalIdentityNumber</span><span class="p">)</span> <span class="p">=</span>
        <span class="n">pin</span><span class="p">.</span><span class="nn">Month</span><span class="p">.</span><span class="nc">Value</span> <span class="p">=</span> <span class="mi">2</span> <span class="p">&amp;&amp;</span> <span class="n">pin</span><span class="p">.</span><span class="nn">Day</span><span class="p">.</span><span class="nc">Value</span> <span class="p">=</span> <span class="mi">29</span>

    <span class="nn">SwedishPersonalIdentityNumberTestData</span><span class="p">.</span><span class="n">allPinsShuffled</span><span class="bp">()</span>
    <span class="p">|&gt;</span> <span class="nn">Seq</span><span class="p">.</span><span class="n">filter</span> <span class="n">isLeapDay</span>
    <span class="p">|&gt;</span> <span class="nn">Seq</span><span class="p">.</span><span class="n">toArray</span>

<span class="k">let</span> <span class="n">leapDayPinGen</span><span class="bp">()</span> <span class="p">=</span>
    <span class="n">leapDayPins</span>
    <span class="p">|&gt;</span> <span class="n">chooseFromArray</span>
    <span class="p">|&gt;</span> <span class="nn">Gen</span><span class="p">.</span><span class="n">map</span> <span class="nc">LeapDayPin</span>
    <span class="p">|&gt;</span> <span class="nn">Arb</span><span class="p">.</span><span class="n">fromGen</span>
</code></pre></div></div>

<p>We use a helper function <code class="highlighter-rouge">isLeapDay</code> to filter out the leap day pins, then wrap them in our single case discriminated union LeapDayPin. The test will look exactly like the test for non leap days except for the calculation of check date where we need to account for the leap day.</p>

<div class="language-fsharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">testProp</span> <span class="s2">"A person born on a leap day also ages by years counting from their date of birth"</span>
    <span class="p">&lt;|</span> <span class="k">fun</span> <span class="p">(</span><span class="nc">LeapDayPin</span> <span class="n">pin</span><span class="p">,</span> <span class="nc">Age</span> <span class="p">(</span><span class="n">years</span><span class="p">,</span> <span class="n">months</span><span class="p">,</span> <span class="n">days</span><span class="o">))</span> <span class="p">-&gt;</span>
        <span class="k">let</span> <span class="n">dateOfBirth</span> <span class="p">=</span> <span class="nc">DateTime</span><span class="p">(</span><span class="n">pin</span><span class="p">.</span><span class="nn">Year</span><span class="p">.</span><span class="nc">Value</span><span class="p">,</span> <span class="n">pin</span><span class="p">.</span><span class="nn">Month</span><span class="p">.</span><span class="nc">Value</span><span class="p">,</span> <span class="n">pin</span><span class="p">.</span><span class="nn">Day</span><span class="p">.</span><span class="nc">Value</span><span class="p">)</span>
        <span class="c1">// Since there isn't a leap day every year we need to add 1 extra day to the checkdate</span>
        <span class="k">let</span> <span class="n">checkDate</span> <span class="p">=</span>
            <span class="n">dateOfBirth</span><span class="p">.</span><span class="nn">Date</span>
                <span class="p">.</span><span class="nc">AddYears</span><span class="p">(</span><span class="n">years</span><span class="p">)</span>
                <span class="p">.</span><span class="nc">AddMonths</span><span class="p">(</span><span class="n">months</span><span class="p">)</span>
                <span class="p">.</span><span class="nc">AddDays</span><span class="p">(</span><span class="n">days</span> <span class="o">+</span> <span class="mi">1</span><span class="o">.)</span>
        <span class="n">pin</span>
        <span class="p">|&gt;</span> <span class="nn">Hints</span><span class="p">.</span><span class="n">getAgeHintOnDate</span> <span class="n">checkDate</span> <span class="o">=!</span> <span class="nc">Some</span> <span class="n">years</span>
</code></pre></div></div>

<h1 id="duplicating-production-code-in-a-test">Duplicating production code in a test</h1>

<p>There are a few usecases worth mentioning when it can be useful to copy the production code implementation to the test.</p>

<h2 id="working-with-legacy-code">Working with legacy code</h2>

<p>When working with legacy code where there are no tests, we can write a test with the production code ase the expected result. Let‚Äôs say we are tasked with refactoring the getAgeHint function from above, but that there are no tests for it.</p>

<div class="language-fsharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">testProp</span> <span class="s2">"The new function should work as the new function"</span>
    <span class="p">&lt;|</span> <span class="k">fun</span> <span class="p">(</span><span class="nc">ValidPin</span> <span class="n">pin</span><span class="p">,</span> <span class="nc">DateTime</span> <span class="n">date</span><span class="p">)</span> <span class="p">-&gt;</span>
        <span class="nn">Hints</span><span class="p">.</span><span class="n">getAgeHintOnDate</span> <span class="n">date</span> <span class="n">pin</span> <span class="o">=!</span> <span class="n">newImplementation</span> <span class="n">date</span> <span class="n">pin</span>
</code></pre></div></div>

<p>The test uses our ValidPin generator to run the test for any pin. We also let FsCheck generate a DateTime to use as the checkdate. If the new implementation does not return the same result as the original implementation the test will fail.</p>

<p>We are now safe to implement a new version of the business logic without being worried of changing any behaviours.</p>

<h2 id="performance">Performance</h2>

<p>If we are tasked with improving the performance of a function we can use the same approach to make sure we don‚Äôt introduce any behaviour changes. And there are some convenient built-in functions in the <a href="https://github.com/haf/expecto#performance-module">Expecto performance module</a> that we can use to compare performance:</p>

<div class="language-fsharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">[&lt;</span><span class="nc">Tests</span><span class="p">&gt;]</span>
<span class="k">let</span> <span class="n">perfTests</span> <span class="p">=</span>
    <span class="n">testSequenced</span> <span class="p">&lt;|</span> <span class="n">testList</span> <span class="s2">"performance tests"</span> <span class="p">[</span>
            <span class="n">testProp</span> <span class="s2">"The new implementation should be faster"</span>
                <span class="p">&lt;|</span> <span class="k">fun</span> <span class="p">(</span><span class="nn">Gen</span><span class="p">.</span><span class="nc">ValidPin</span> <span class="n">pin</span><span class="p">,</span> <span class="nc">DateTime</span> <span class="n">date</span><span class="p">)</span> <span class="p">-&gt;</span>
                    <span class="nn">Expect</span><span class="p">.</span><span class="n">isFasterThan</span> 
                        <span class="p">(</span><span class="k">fun</span> <span class="bp">()</span> <span class="p">-&gt;</span> <span class="n">newImplementation</span> <span class="n">date</span> <span class="n">pin</span><span class="p">)</span> 
                        <span class="p">(</span><span class="k">fun</span> <span class="bp">()</span> <span class="p">-&gt;</span> <span class="nn">Hints</span><span class="p">.</span><span class="n">getAgeHintOnDate</span> <span class="n">date</span> <span class="n">pin</span><span class="p">)</span> 
                        <span class="s2">"new implementation is faster"</span>
    <span class="p">]</span>
</code></pre></div></div>

<p>This test will fail as long as the new implementation is not faster than the old function. I am showing the full test setup here because it is important to remember to run any performance tests in sequence using <code class="highlighter-rouge">testSequenced</code>. By default Expecto will run all tests in parallel which will not work with performance tests.</p>

<h1 id="conclusions">Conclusions</h1>

<p>So, in the end, what are my thoughts on property based testing after migrating a unit test suite to property tests?</p>

<p>I like it a lot üôÇ. It does require a new mindset and it still takes longer for me to think of the right tests to write. But in the end I was able to test the same requirements with a lot less actual test code. Comparing the test suites, with generators and all, the C# test suite had 1035 lines of code compared to 748 for the F# property tests. Maybe even more telling is to compare the number of tests, 91 with example based tests in C# and 43 with property based tests in F#.</p>

<p>Besides having less tests to maintain I also discovered two bugs in the process of writing the new tests. Having to think of properties of your code can give you some useful insights.</p>

<p>This codebase was pretty well suited to be tested by properties, and I imagine that will not be the case for all types of code. Without experience it can take some time to express your requirements as properties. For example the test for <code class="highlighter-rouge">getAgeHintOnDate</code> above did actually take me a few nights to figure out and get right. So I am not advocating that you <strong>have</strong> to replace all your tests with property based tests. Example based unit tests are better than <strong>no</strong> tests.</p>

<p>So if you are struggling to write property tests at first, go ahead and write normal example based unit tests. Then, later, when you realise that some requirements can be expressed as a testable property, do a refactoring and replace the unit tests with property tests!</p>

<div class="footnotes">
  <ol>
    <li id="fn:1">
      <p>This is true in most cases, but not always. The identity numbers for any given day can actually run out and then you would be ‚Äúmoved‚Äù to another nearby day within the same month. The functions the <a href="">Active.Identity</a> uses to determine date of birth and age are therefore placed in a <code class="highlighter-rouge">Hints</code> namespace to make it clear that the results must not be used as an absolute truth.¬†<a href="#fnref:1" class="reversefootnote">&#8617;</a></p>
    </li>
    <li id="fn:2">
      <p>There is a wrapper we are not seeing here that handles the conversion of age from <code class="highlighter-rouge">int option</code> to int when calling from C#. It makes the conversion of <code class="highlighter-rouge">None</code> to 0.¬†<a href="#fnref:2" class="reversefootnote">&#8617;</a></p>
    </li>
    <li id="fn:3">
      <p>In the 10-digit format YYMMDD-bbbc the delimiter changes to a <strong>+</strong> the year you turn 100. But there is no delimiter change when your age changes from 199 to 200. For historical reasons üòâ.¬†<a href="#fnref:3" class="reversefootnote">&#8617;</a></p>
    </li>
  </ol>
</div>

        
      </section>

      <footer class="page__meta">
        
        
  


  
  
  

  <p class="page__taxonomy">
    <strong><i class="fas fa-fw fa-tags" aria-hidden="true"></i> Tags: </strong>
    <span itemprop="keywords">
    
      
      
      <a href="/tags/#fsharp" class="page__taxonomy-item" rel="tag">fsharp</a><span class="sep">, </span>
    
      
      
      <a href="/tags/#property-based-tests" class="page__taxonomy-item" rel="tag">property based tests</a><span class="sep">, </span>
    
      
      
      <a href="/tags/#tests" class="page__taxonomy-item" rel="tag">tests</a>
    
    </span>
  </p>




  


  
  
  

  <p class="page__taxonomy">
    <strong><i class="fas fa-fw fa-folder-open" aria-hidden="true"></i> Categories: </strong>
    <span itemprop="keywords">
    
      
      
      <a href="/categories/#fsharp" class="page__taxonomy-item" rel="tag">fsharp</a>
    
    </span>
  </p>


        
          <p class="page__date"><strong><i class="fas fa-fw fa-calendar-alt" aria-hidden="true"></i> Updated:</strong> <time datetime="2019-09-05T17:00:00+02:00">September 05, 2019</time></p>
        
      </footer>

      <section class="page__share">
  

  <a href="https://twitter.com/intent/tweet?via=Emmet_Ray&text=Migrating+a+C%23+test+suite+to+property+based+tests+in+F%23+-+part+4%20https%3A%2F%2Fviktorvan.github.io%2Ffsharp%2Fmigrating-activelogin.identity-to-property-based-tests-4%2F" class="btn btn--twitter" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on Twitter"><i class="fab fa-fw fa-twitter" aria-hidden="true"></i><span> Twitter</span></a>

  <a href="https://www.facebook.com/sharer/sharer.php?u=https%3A%2F%2Fviktorvan.github.io%2Ffsharp%2Fmigrating-activelogin.identity-to-property-based-tests-4%2F" class="btn btn--facebook" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on Facebook"><i class="fab fa-fw fa-facebook" aria-hidden="true"></i><span> Facebook</span></a>

  <a href="https://www.linkedin.com/shareArticle?mini=true&url=https%3A%2F%2Fviktorvan.github.io%2Ffsharp%2Fmigrating-activelogin.identity-to-property-based-tests-4%2F" class="btn btn--linkedin" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on LinkedIn"><i class="fab fa-fw fa-linkedin" aria-hidden="true"></i><span> LinkedIn</span></a>
</section>


      
  <nav class="pagination">
    
      <a href="/fsharp/migrating-activelogin.identity-to-property-based-tests-3/" class="pagination--pager" title="Migrating a C# test suite to property based tests in F# - part 3
">Previous</a>
    
    
      <a href="#" class="pagination--pager disabled">Next</a>
    
  </nav>

    </div>

    
  </article>

  
  
    <div class="page__related">
      <h4 class="page__related-title">You May Also Enjoy</h4>
      <div class="grid__wrapper">
        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title" itemprop="headline">
      
        <a href="/fsharp/migrating-activelogin.identity-to-property-based-tests-3/" rel="permalink">Migrating a C# test suite to property based tests in F# - part 3
</a>
      
    </h2>
    
      <p class="page__meta"><i class="far fa-clock" aria-hidden="true"></i> 




  8 minute read
</p>
    
    <p class="archive__item-excerpt" itemprop="description">Property based tests part 3 - generators with too many output values.

</p>
  </article>
</div>

        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title" itemprop="headline">
      
        <a href="/fsharp/migrating-activelogin.identity-to-property-based-tests-2/" rel="permalink">Migrating a C# test suite to property based tests in F# - part 2
</a>
      
    </h2>
    
      <p class="page__meta"><i class="far fa-clock" aria-hidden="true"></i> 




  8 minute read
</p>
    
    <p class="archive__item-excerpt" itemprop="description">Property based tests part 2 - More about generators.

</p>
  </article>
</div>

        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title" itemprop="headline">
      
        <a href="/fsharp/migrating-activelogin.identity-to-property-based-tests-1/" rel="permalink">Migrating a C# test suite to property based tests in F# - part 1
</a>
      
    </h2>
    
      <p class="page__meta"><i class="far fa-clock" aria-hidden="true"></i> 




  13 minute read
</p>
    
    <p class="archive__item-excerpt" itemprop="description">I‚Äôve been wanting to try property-based testing in a real-life situation for some time, and decided to try it out with the test suite for our open source lib...</p>
  </article>
</div>

        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title" itemprop="headline">
      
        <a href="/fsharp/domain-modeling-with-fsharp/" rel="permalink">Why you should model your domain with F#
</a>
      
    </h2>
    
      <p class="page__meta"><i class="far fa-clock" aria-hidden="true"></i> 




  12 minute read
</p>
    
    <p class="archive__item-excerpt" itemprop="description">Recently when working on a feature for a client, writing the normal barrage of C# null-checks and unit-tests verifying that my model state wasn‚Äôt invalid, a ...</p>
  </article>
</div>

        
      </div>
    </div>
  
  
</div>

    </div>

    

    <div id="footer" class="page__footer">
      <footer>
        <!-- start custom footer snippets -->

<!-- end custom footer snippets -->
        <div class="page__footer-follow">
  <ul class="social-icons">
    

    
      
        
          <li><a href="https://twitter.com/Emmet_Ray" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-twitter-square" aria-hidden="true"></i> Twitter</a></li>
        
      
        
      
        
      
        
      
        
      
        
      
    

    <li><a href="/feed.xml"><i class="fas fa-fw fa-rss-square" aria-hidden="true"></i> Feed</a></li>
  </ul>
</div>

<div class="page__footer-copyright">&copy; 2019 Viktor Andersson. Powered by <a href="https://jekyllrb.com" rel="nofollow">Jekyll</a> &amp; <a href="https://mademistakes.com/work/minimal-mistakes-jekyll-theme/" rel="nofollow">Minimal Mistakes</a>.</div>

      </footer>
    </div>

    
  <script src="/assets/js/main.min.js"></script>
  <script src="https://kit.fontawesome.com/4eee35f757.js"></script>










  </body>
</html>
